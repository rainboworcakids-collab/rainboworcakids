<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Missions | Rainbow OrcaKids</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- SweetAlert2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dialog ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Select2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dropdown ‡∏ó‡∏µ‡πà‡∏î‡∏µ -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
</head>

<body class="font-sarabun bg-gray-50">
    <!-- Navigation ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ nav.js -->
    
    <div class="container mx-auto px-4 py-8">

        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-700 mb-2">
                    <i class="fas fa-tasks mr-3"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Missions
                </h1>
                <p class="text-gray-600">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>
            
            <div class="flex gap-3">
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard -->
                <a href="admin_dashboard.html" 
                   class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition duration-200">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </a>
                
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° Mission ‡πÉ‡∏´‡∏°‡πà -->
                <button onclick="showAddMissionModal()" 
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition duration-200">
                    <i class="fas fa-plus mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏° Mission ‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-lg shadow border border-blue-100">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <i class="fas fa-tasks text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">‡∏£‡∏ß‡∏° Missions</p>
                        <p id="totalMissions" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-green-100">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                        <i class="fas fa-gamepad text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Missions ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Game</p>
                        <p id="gameMissions" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-yellow-100">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                        <i class="fas fa-medal text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Egg Reward ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
                        <p id="maxEggReward" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-purple-100">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                        <i class="fas fa-layer-group text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô</p>
                        <p id="avgComplexity" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                    <div class="relative">
                        <input type="text" id="searchInput" 
                               placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à, ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢, prompt..."
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <select id="missionTypeFilter" 
                            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 w-40">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                        <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                    </select>
                    
                    <select id="complexityFilter" 
                            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 w-32">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô</option>
                        <option value="easy">‡∏á‡πà‡∏≤‡∏¢</option>
                        <option value="medium">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                        <option value="hard">‡∏¢‡∏≤‡∏Å</option>
                        <option value="expert">‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</option>
                    </select>
                    
                    <button onclick="loadMissions()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingStatus" class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-gray-700 mb-6">
            <i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Missions...
        </div>

        <!-- Missions Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-flag mr-1"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-tag mr-1"></i>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-chart-line mr-1"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-egg mr-1"></i>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏Ç‡πà
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-graduation-cap mr-1"></i>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-calendar mr-1"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-cogs mr-1"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                            </th>
                        </tr>
                    </thead>
                    <tbody id="missionsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Data Message (hidden by default) -->
        <div id="noDataMessage" class="hidden text-center py-12">
            <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-500 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Missions</h3>
            <p class="text-gray-400 mb-6">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Mission ‡πÉ‡∏´‡∏°‡πà</p>
            <button onclick="showAddMissionModal()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">
                <i class="fas fa-plus mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏° Mission ‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>

        <!-- Back Button -->
        <div class="text-center">
            <a href="admin_dashboard.html" class="inline-flex items-center text-blue-600 hover:text-blue-800 font-semibold">
                <i class="fas fa-arrow-left mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard
            </a>
        </div>
    </div>

    <!-- Add/Edit Mission Modal (hidden by default) -->
    <div id="missionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-700"></h3>
                <button onclick="closeMissionModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="mt-6">
                <form id="missionForm" onsubmit="saveMission(event)">
                    <input type="hidden" id="missionId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Mission Title -->
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-flag mr-1"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à *
                            </label>
                            <input type="text" id="missionTitle" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏∞‡πÄ‡∏•"
                                   required>
                        </div>

                        <!-- Mission Type -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-tag mr-1"></i>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à *
                            </label>
                            <select id="missionType" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</option>
                                <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                            </select>
                        </div>

                        <!-- Complexity Level -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-chart-line mr-1"></i>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô *
                            </label>
                            <select id="complexityLevel" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required>
                                <option value="easy">‡∏á‡πà‡∏≤‡∏¢</option>
                                <option value="medium" selected>‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                                <option value="hard">‡∏¢‡∏≤‡∏Å</option>
                                <option value="expert">‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</option>
                            </select>
                        </div>

                        <!-- Egg Reward -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-egg mr-1"></i>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏Ç‡πà *
                            </label>
                            <input type="number" id="eggReward" min="0" max="1000"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   value="10"
                                   required>
                            <p class="text-xs text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏Ç‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                        </div>

                        <!-- Target Grade Level -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-graduation-cap mr-1"></i>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
                            </label>
                            <select id="targetGradeLevel" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                            </select>
                        </div>

                        <!-- Lesson ID -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-book mr-1"></i>‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Lesson)
                            </label>
                            <select id="lessonId" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
                                <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                            </select>
                        </div>

                        <!-- Schema Version -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-code-branch mr-1"></i>Schema Version
                            </label>
                            <input type="text" id="schemaVersion" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   value="1.0.0"
                                   placeholder="1.0.0">
                        </div>

                        <!-- Prompt Template -->
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-comment-dots mr-1"></i>Prompt Template *
                            </label>
                            <textarea id="promptTemplate" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                      placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏∞‡πÄ‡∏•‡∏ï‡∏≤‡∏°‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£..."
                                      required></textarea>
                            <p class="text-xs text-gray-500 mt-1">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</p>
                        </div>

                        <!-- Audio Script -->
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-microphone mr-1"></i>‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                            </label>
                            <textarea id="audioScript" rows="2"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                      placeholder="‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à..."></textarea>
                        </div>

                        <!-- Creator UID -->
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-user-edit mr-1"></i>‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á (Creator UID)
                            </label>
                            <input type="text" id="creatorUid" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="UUID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à">
                            <p class="text-xs text-gray-500 mt-1">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-3 mt-8 pt-4 border-t">
                        <button type="button" onclick="closeMissionModal()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button type="submit" id="submitButton"
                                class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center">
                            <i class="fas fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/supabase-config.js"></script>
    <script src="js/auth_status_manager.js"></script>
    <script src="js/nav.js"></script>
    
    <!-- Debug Logger -->
    <script src="js/debug-logger.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üîê Checking admin permission for this page...");
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå admin
            const hasPermission = await checkAdminPermission();
            
            if (!hasPermission) {
                // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ dashboard
                Swal.fire({
                    icon: 'warning',
                    title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á',
                    text: '‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                    confirmButtonText: '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = 'admin_dashboard.html';
                    }
                });
                return;
            }
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å
            loadPageContent();
        });

        // ===============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö admin permission
        // ===============================================
        async function checkAdminPermission() {
            try {
                console.log("üîç Checking admin permission...");
                
                const supabase = await getSupabaseClient();
                if (!supabase) {
                    console.error("‚ùå Supabase client not available");
                    return false;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                if (sessionError) {
                    console.error("‚ùå Session error:", sessionError);
                    return false;
                }
                
                if (!session || !session.user) {
                    console.warn("‚ö†Ô∏è No user session found");
                    return false;
                }
                
                console.log("üë§ User logged in:", session.user.email);
                
                // ‡πÉ‡∏ä‡πâ fetchUserProfile
                if (typeof window.fetchUserProfile !== 'function') {
                    console.error("‚ùå fetchUserProfile function not available");
                    return false;
                }
                
                const profile = await window.fetchUserProfile(session.user);
                console.log("üìä User profile:", profile);
                
                if (!profile) {
                    console.error("‚ùå Cannot fetch user profile");
                    return false;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ role ‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const isAdmin = profile.role === 'admin' || 
                               profile.role === 'administrator' || 
                               profile.role === 'superadmin';
                
                if (isAdmin) {
                    console.log("‚úÖ Admin permission granted");
                } else {
                    console.warn("‚ö†Ô∏è User is not an admin, role:", profile.role);
                }
                
                return isAdmin;
                
            } catch (error) {
                console.error("‚ùå Error in checkAdminPermission:", error);
                return false;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å
        async function loadPageContent() {
            console.log("‚úÖ Admin permission verified, loading page content...");
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dropdowns
            await loadDropdownData();
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners
            document.getElementById('searchInput').addEventListener('keyup', filterMissions);
            document.getElementById('missionTypeFilter').addEventListener('change', filterMissions);
            document.getElementById('complexityFilter').addEventListener('change', filterMissions);
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Missions
            await loadMissions();
            
            // Initialize Debug Logger
            initDebugLogger();
        }

        // ===============================================
        // Missions Management JavaScript
        // ===============================================
        let currentMissions = [];
        let isEditMode = false;
        let missionTypes = [];
        let grades = [];
        let lessons = [];
        
        // Debug Logger wrapper functions
        function logSuccess(message) {
            if (window.DebugLogger && typeof window.DebugLogger.success === 'function') {
                window.DebugLogger.success(message);
            } else {
                console.log('‚úÖ ' + message);
            }
        }
        
        function logError(message) {
            if (window.DebugLogger && typeof window.DebugLogger.error === 'function') {
                window.DebugLogger.error(message);
            } else {
                console.error('‚ùå ' + message);
            }
        }
        
        function logInfo(message) {
            if (window.DebugLogger && typeof window.DebugLogger.info === 'function') {
                window.DebugLogger.info(message);
            } else {
                console.info('‚ÑπÔ∏è ' + message);
            }
        }
        
        function logWarning(message) {
            if (window.DebugLogger && typeof window.DebugLogger.warning === 'function') {
                window.DebugLogger.warning(message);
            } else {
                console.warn('‚ö†Ô∏è ' + message);
            }
        }
        
        // Fallback Debug Logger
        if (!window.DebugLogger) {
            console.log('‚ö†Ô∏è DebugLogger not found, using fallback logger');
            window.DebugLogger = {
                init: function() { console.log('Fallback DebugLogger initialized'); },
                log: function(msg, type) { 
                    const icon = type === 'success' ? '‚úÖ' : 
                                type === 'error' ? '‚ùå' : 
                                type === 'warning' ? '‚ö†Ô∏è' : 
                                type === 'info' ? 'üîµ' : 'üìù';
                    console.log(`${icon} ${msg}`);
                },
                success: function(msg) { console.log('‚úÖ ' + msg); },
                error: function(msg) { console.error('‚ùå ' + msg); },
                warning: function(msg) { console.warn('‚ö†Ô∏è ' + msg); },
                info: function(msg) { console.info('‚ÑπÔ∏è ' + msg); },
                debug: function(msg) { console.debug('üêõ ' + msg); }
            };
        }
        
        function initDebugLogger() {
            if (window.DebugLogger && typeof window.DebugLogger.init === 'function') {
                try {
                    window.DebugLogger.init();
                    console.log('‚úÖ DebugLogger initialized');
                } catch (e) {
                    console.warn('‚ö†Ô∏è DebugLogger init failed:', e);
                }
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dropdowns
        async function loadDropdownData() {
            try {
                const supabase = await getSupabaseClient();
                if (!supabase) return;

                // ‡πÇ‡∏´‡∏•‡∏î mission types
                const { data: types, error: typesError } = await supabase
                    .from('mission_types')
                    .select('type_key, type_name_th')
                    .eq('is_active', true)
                    .order('display_order');
                
                if (!typesError) {
                    missionTypes = types;
                    populateMissionTypeDropdowns();
                }
                
                // ‡πÇ‡∏´‡∏•‡∏î grades
                const { data: gradesData, error: gradesError } = await supabase
                    .from('grades')
                    .select('grade_level, grade_name_th')
                    .eq('is_active', true)
                    .order('grade_level');
                
                if (!gradesError) {
                    grades = gradesData;
                    populateGradesDropdown();
                }
                
                // ‡πÇ‡∏´‡∏•‡∏î lessons (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
                const { data: lessonsData, error: lessonsError } = await supabase
                    .from('lessons')
                    .select('lesson_id, story_summary')
                    .limit(50); // Limit to prevent too many options
                
                if (!lessonsError) {
                    lessons = lessonsData;
                    populateLessonsDropdown();
                }
                
            } catch (error) {
                console.error('Error loading dropdown data:', error);
            }
        }

        function populateMissionTypeDropdowns() {
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö filter dropdown
            const filterSelect = document.getElementById('missionTypeFilter');
            filterSelect.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>';
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö form dropdown
            const formSelect = document.getElementById('missionType');
            formSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</option>';
            
            missionTypes.forEach(type => {
                // Add to filter dropdown
                const filterOption = document.createElement('option');
                filterOption.value = type.type_key;
                filterOption.textContent = type.type_name_th;
                filterSelect.appendChild(filterOption);
                
                // Add to form dropdown
                const formOption = document.createElement('option');
                formOption.value = type.type_key;
                formOption.textContent = type.type_name_th;
                formSelect.appendChild(formOption);
            });
        }

        function populateGradesDropdown() {
            const select = document.getElementById('targetGradeLevel');
            select.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade.grade_level;
                option.textContent = `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${grade.grade_level}: ${grade.grade_name_th}`;
                select.appendChild(option);
            });
        }

        function populateLessonsDropdown() {
            const select = document.getElementById('lessonId');
            select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>';
            
            lessons.forEach(lesson => {
                const option = document.createElement('option');
                option.value = lesson.lesson_id;
                
                // ‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô
                let displayText = lesson.story_summary || `Lesson ${lesson.lesson_id.substring(0, 8)}`;
                if (displayText.length > 50) {
                    displayText = displayText.substring(0, 47) + '...';
                }
                
                option.textContent = displayText;
                option.title = lesson.story_summary || lesson.lesson_id;
                select.appendChild(option);
            });
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Missions ‡∏à‡∏≤‡∏Å Supabase
        async function loadMissions() {
            const loadingStatus = document.getElementById('loadingStatus');
            const noDataMessage = document.getElementById('noDataMessage');
            const tableBody = document.getElementById('missionsTableBody');
            
            loadingStatus.classList.remove('hidden');
            tableBody.innerHTML = '';
            
            try {
                const supabase = await getSupabaseClient();
                if (!supabase) {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    return;
                }
                
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• missions ‡∏û‡∏£‡πâ‡∏≠‡∏° join ‡∏Å‡∏±‡∏ö mission_types
                const { data: missions, error } = await supabase
                    .from('missions')
                    .select(`
                        *,
                        mission_types:mission_type (type_name_th)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                currentMissions = missions || [];
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                updateStats(currentMissions);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                if (currentMissions.length > 0) {
                    renderMissionsTable(currentMissions);
                    noDataMessage.classList.add('hidden');
                } else {
                    tableBody.innerHTML = '';
                    noDataMessage.classList.remove('hidden');
                }
                
                loadingStatus.classList.add('hidden');
                
                logSuccess(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Missions ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${currentMissions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                
            } catch (error) {
                loadingStatus.classList.add('hidden');
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Missions ‡πÑ‡∏î‡πâ: ' + error.message);
                logError('Error loading missions: ' + error.message);
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function renderMissionsTable(missions) {
            const tableBody = document.getElementById('missionsTableBody');
            tableBody.innerHTML = '';
            
            missions.forEach((mission, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                // ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                const createdDate = new Date(mission.created_at).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
                let complexityColor = 'bg-green-100 text-green-800';
                let complexityText = '‡∏á‡πà‡∏≤‡∏¢';
                
                switch(mission.complexity_level) {
                    case 'medium': 
                        complexityColor = 'bg-yellow-100 text-yellow-800';
                        complexityText = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
                        break;
                    case 'hard': 
                        complexityColor = 'bg-orange-100 text-orange-800';
                        complexityText = '‡∏¢‡∏≤‡∏Å';
                        break;
                    case 'expert': 
                        complexityColor = 'bg-red-100 text-red-800';
                        complexityText = '‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç';
                        break;
                }
                
                // ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï prompt template
                let promptPreview = mission.prompt_template || '-';
                if (promptPreview.length > 50) {
                    promptPreview = promptPreview.substring(0, 47) + '...';
                }
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
                let typeColor = 'bg-blue-100 text-blue-800';
                if (mission.mission_type === 'game') {
                    typeColor = 'bg-purple-100 text-purple-800';
                } else if (mission.mission_type === 'quiz') {
                    typeColor = 'bg-green-100 text-green-800';
                } else if (mission.mission_type === 'creative') {
                    typeColor = 'bg-pink-100 text-pink-800';
                }
                
                // ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
                const missionTypeName = mission.mission_types?.type_name_th || mission.mission_type;
                
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${mission.mission_title}</div>
                        <div class="text-xs text-gray-500 truncate max-w-xs" title="${mission.prompt_template || ''}">
                            ${promptPreview}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${typeColor}">
                            ${missionTypeName}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${complexityColor}">
                            ${complexityText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-yellow-700">
                        <i class="fas fa-egg mr-1"></i>${mission.egg_reward || 0}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${mission.target_grade_level_id ? `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${mission.target_grade_level_id}` : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <i class="far fa-clock mr-1"></i>${createdDate}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewMissionDetails('${mission.mission_id}')" 
                                class="text-blue-600 hover:text-blue-900 mr-3" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="editMission('${mission.mission_id}')" 
                                class="text-green-600 hover:text-green-900 mr-3" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMission('${mission.mission_id}', '${mission.mission_title}')" 
                                class="text-red-600 hover:text-red-900" title="‡∏•‡∏ö">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Mission
        async function viewMissionDetails(missionId) {
            try {
                const supabase = await getSupabaseClient();
                if (!supabase) {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    return;
                }
                
                const { data: mission, error } = await supabase
                    .from('missions')
                    .select(`
                        *,
                        mission_types:mission_type (type_name_th, type_name_en, description),
                        lessons:lesson_id (story_summary),
                        grades:target_grade_level_id (grade_name_th)
                    `)
                    .eq('mission_id', missionId)
                    .single();
                
                if (error) throw error;
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á
                let detailsHtml = `
                    <div class="text-left space-y-3">
                        <div>
                            <h4 class="font-bold text-blue-700">‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à:</h4>
                            <p class="text-gray-700">${mission.mission_title}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <h4 class="font-bold text-blue-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</h4>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                    ${mission.mission_types?.type_name_th || mission.mission_type}
                                </span>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-blue-700">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô:</h4>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    ${mission.complexity_level}
                                </span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <h4 class="font-bold text-blue-700">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏Ç‡πà:</h4>
                                <p class="text-yellow-700 font-bold"><i class="fas fa-egg mr-1"></i>${mission.egg_reward || 0}</p>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-blue-700">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</h4>
                                <p>${mission.target_grade_level_id ? `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${mission.target_grade_level_id}` : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-blue-700">Prompt Template:</h4>
                            <div class="bg-gray-50 p-3 rounded border font-mono text-sm">
                                ${mission.prompt_template || '-'}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-blue-700">Audio Script:</h4>
                            <div class="bg-gray-50 p-3 rounded border">
                                ${mission.audio_script || '-'}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <h4 class="font-bold text-blue-700">Schema Version:</h4>
                                <p>${mission.schema_version}</p>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-blue-700">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:</h4>
                                <p>${new Date(mission.created_at).toLocaleDateString('th-TH')}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                Swal.fire({
                    title: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à',
                    html: detailsHtml,
                    width: 700,
                    confirmButtonText: '‡∏õ‡∏¥‡∏î',
                    showCloseButton: true
                });
                
            } catch (error) {
                console.error('Error viewing mission details:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        function updateStats(missions) {
            const total = missions.length;
            const gameMissions = missions.filter(m => m.mission_type === 'game').length;
            
            // ‡∏´‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
            const eggRewards = missions.map(m => m.egg_reward || 0);
            const maxEggReward = eggRewards.length > 0 ? Math.max(...eggRewards) : 0;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
            const complexityValues = {
                'easy': 1,
                'medium': 2,
                'hard': 3,
                'expert': 4
            };
            
            const complexityScores = missions.map(m => complexityValues[m.complexity_level] || 1);
            const avgComplexity = complexityScores.length > 0 
                ? (complexityScores.reduce((a, b) => a + b, 0) / complexityScores.length).toFixed(1)
                : '0.0';
            
            document.getElementById('totalMissions').textContent = total;
            document.getElementById('gameMissions').textContent = gameMissions;
            document.getElementById('maxEggReward').textContent = maxEggReward;
            document.getElementById('avgComplexity').textContent = avgComplexity;
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Missions
        function filterMissions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('missionTypeFilter').value;
            const complexityFilter = document.getElementById('complexityFilter').value;
            
            let filtered = currentMissions;
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            if (searchTerm) {
                filtered = filtered.filter(mission => 
                    mission.mission_title.toLowerCase().includes(searchTerm) ||
                    mission.prompt_template?.toLowerCase().includes(searchTerm) ||
                    mission.audio_script?.toLowerCase().includes(searchTerm)
                );
            }
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
            if (typeFilter !== 'all') {
                filtered = filtered.filter(mission => mission.mission_type === typeFilter);
            }
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
            if (complexityFilter !== 'all') {
                filtered = filtered.filter(mission => mission.complexity_level === complexityFilter);
            }
            
            renderMissionsTable(filtered);
        }

        // ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° Mission
        async function showAddMissionModal() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏° Mission ‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('submitButton').innerHTML = '<i class="fas fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('missionForm').reset();
            document.getElementById('missionId').value = '';
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default values
            document.getElementById('schemaVersion').value = '1.0.0';
            document.getElementById('eggReward').value = '10';
            document.getElementById('complexityLevel').value = 'medium';
            
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î dropdown data ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î
            if (missionTypes.length === 0) {
                await loadDropdownData();
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á Modal
            document.getElementById('missionModal').classList.remove('hidden');
        }

        // ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Mission
        async function editMission(missionId) {
            const mission = currentMissions.find(m => m.mission_id === missionId);
            if (!mission) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mission ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
                return;
            }
            
            isEditMode = true;
            document.getElementById('modalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Mission';
            document.getElementById('submitButton').innerHTML = '<i class="fas fa-save mr-2"></i>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î dropdown data ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î
            if (missionTypes.length === 0) {
                await loadDropdownData();
            }
            
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('missionId').value = mission.mission_id;
            document.getElementById('missionTitle').value = mission.mission_title;
            document.getElementById('missionType').value = mission.mission_type;
            document.getElementById('complexityLevel').value = mission.complexity_level;
            document.getElementById('eggReward').value = mission.egg_reward || 10;
            document.getElementById('targetGradeLevel').value = mission.target_grade_level_id || '';
            document.getElementById('lessonId').value = mission.lesson_id || '';
            document.getElementById('schemaVersion').value = mission.schema_version || '1.0.0';
            document.getElementById('promptTemplate').value = mission.prompt_template || '';
            document.getElementById('audioScript').value = mission.audio_script || '';
            document.getElementById('creatorUid').value = mission.creator_uid || '';
            
            // ‡πÅ‡∏™‡∏î‡∏á Modal
            document.getElementById('missionModal').classList.remove('hidden');
        }

        // ‡∏õ‡∏¥‡∏î Modal
        function closeMissionModal() {
            document.getElementById('missionModal').classList.add('hidden');
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mission
        async function saveMission(event) {
            event.preventDefault();
            
            try {
                const supabase = await getSupabaseClient();
                if (!supabase) {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    return;
                }
                
                const missionData = {
                    mission_title: document.getElementById('missionTitle').value.trim(),
                    mission_type: document.getElementById('missionType').value,
                    complexity_level: document.getElementById('complexityLevel').value,
                    egg_reward: parseInt(document.getElementById('eggReward').value) || 0,
                    target_grade_level_id: document.getElementById('targetGradeLevel').value || null,
                    lesson_id: document.getElementById('lessonId').value || null,
                    schema_version: document.getElementById('schemaVersion').value.trim() || '1.0.0',
                    prompt_template: document.getElementById('promptTemplate').value.trim(),
                    audio_script: document.getElementById('audioScript').value.trim() || null,
                    creator_uid: document.getElementById('creatorUid').value.trim() || null
                };
                
                const missionId = document.getElementById('missionId').value;
                
                let result;
                if (isEditMode && missionId) {
                    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    const { data, error } = await supabase
                        .from('missions')
                        .update(missionData)
                        .eq('mission_id', missionId)
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                    
                    logSuccess(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Mission ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${missionData.mission_title}`);
                    
                } else {
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    const { data, error } = await supabase
                        .from('missions')
                        .insert([missionData])
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                    
                    logSuccess(`‡πÄ‡∏û‡∏¥‡πà‡∏° Mission ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${missionData.mission_title}`);
                }
                
                // ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                closeMissionModal();
                await loadMissions();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mission "${missionData.mission_title}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,
                    timer: 2000,
                    showConfirmButton: false
                });
                
            } catch (error) {
                console.error('Error saving mission:', error);
                
                if (error.code === '23503') { // Foreign key violation
                    showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô mission_type, lesson_id) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                } else if (error.code === '23505') { // Unique violation
                    showError('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                } else {
                    showError('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
                }
                
                logError('Error saving mission: ' + error.message);
            }
        }

        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mission
        async function deleteMission(missionId, missionTitle) {
            // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Mission "${missionTitle}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });
            
            if (!result.isConfirmed) return;
            
            try {
                const supabase = await getSupabaseClient();
                if (!supabase) {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                    return;
                }
                
                const { error } = await supabase
                    .from('missions')
                    .delete()
                    .eq('mission_id', missionId);
                
                if (error) throw error;
                
                logSuccess(`‡∏•‡∏ö Mission ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${missionTitle}`);
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                await loadMissions();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                Swal.fire({
                    icon: 'success',
                    title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡∏•‡∏ö Mission "${missionTitle}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`,
                    timer: 2000,
                    showConfirmButton: false
                });
                
            } catch (error) {
                console.error('Error deleting mission:', error);
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Mission ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (error.code === '23503') { // Foreign key violation
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö Mission ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô, ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏Å‡∏£‡∏™)');
                } else {
                    showError('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
                }
                
                logError('Error deleting mission: ' + error.message);
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                text: message,
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            });
        }
    </script>
    
    <style>
        /* Custom styles */
        .hover-scale {
            transition: transform 0.2s ease-in-out;
        }
        .hover-scale:hover {
            transform: translateY(-2px);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            ring: 2px;
        }
        
        /* Scrollbar styling */
        #missionsTableBody::-webkit-scrollbar {
            width: 6px;
        }
        
        #missionsTableBody::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        #missionsTableBody::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        #missionsTableBody::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Complexity badges */
        .badge-easy { background-color: #d1fae5; color: #065f46; border-color: #10b981; }
        .badge-medium { background-color: #fef3c7; color: #92400e; border-color: #fbbf24; }
        .badge-hard { background-color: #fed7aa; color: #9a3412; border-color: #f97316; }
        .badge-expert { background-color: #fecaca; color: #991b1b; border-color: #ef4444; }
    </style>
</body>
</html>
<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ | Rainbow OrcaKids</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- SweetAlert2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dialog ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body class="font-sarabun bg-gray-50">
    <!-- Admin Header (Simple) -->
    <div class="bg-white shadow-md border-b border-gray-200">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <!-- Logo -->
                <a href="admin_dashboard.html" class="flex items-center space-x-2">
                    <i class="fas fa-rainbow text-blue-600 text-2xl"></i>
                    <span class="text-xl font-bold text-blue-700">Rainbow OrcaKids Admin</span>
                </a>
                
                <!-- Admin Controls -->
                <div class="flex space-x-3">
                    <a href="admin_dashboard.html" 
                       class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md transition-colors">
                        <i class="fas fa-tachometer-alt mr-1"></i>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                    </a>
                    <div class="relative">
                        <button onclick="adminLogout()" 
                               class="text-red-600 hover:text-red-800 px-3 py-2 rounded-md hover:bg-red-50 transition-colors">
                            <i class="fas fa-sign-out-alt mr-1"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">

        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-blue-700 mb-2">
                    <i class="fas fa-users mr-3"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                </h1>
                <p class="text-gray-600">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
            </div>
            
            <div class="flex gap-3">
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard -->
                <a href="admin_dashboard.html" 
                   class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition duration-200">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </a>
                
            </div>
        </div>

        <!-- RPC Status Alert -->
        <div id="rpcStatusAlert" class="hidden mb-6">
            <!-- ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ RPC functions -->
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-lg shadow border border-blue-100">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
                        <p id="totalUsers" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-green-100">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                        <i class="fas fa-chalkboard-teacher text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">‡∏Ñ‡∏£‡∏π/‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</p>
                        <p id="teacherCount" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-yellow-100">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                        <i class="fas fa-user-check text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</p>
                        <p id="creatorCount" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-purple-100">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                        <i class="fas fa-egg text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">‡πÑ‡∏Ç‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <p id="totalEggs" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                    <div class="relative">
                        <input type="text" id="searchInput" 
                               placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠, ‡∏≠‡∏µ‡πÄ‡∏°‡∏•, UID..."
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <select id="roleFilter" 
                            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="all">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <!-- ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å roles table -->
                    </select>
                    <select id="gradeFilter" 
                            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="all">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <!-- ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å grades table -->
                    </select>
                    <button onclick="loadUsers()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingStatus" class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-gray-700 mb-6">
            <i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...
        </div>

        <!-- Users Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-user mr-1"></i>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-envelope mr-1"></i>‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-user-tag mr-1"></i>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-graduation-cap mr-1"></i>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-egg mr-1"></i>‡πÑ‡∏Ç‡πà
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-star mr-1"></i>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-calendar mr-1"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-cogs mr-1"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                            </th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Data Message (hidden by default) -->
        <div id="noDataMessage" class="hidden text-center py-12">
            <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-500 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
            <p class="text-gray-400 mb-6">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</p>
            <button onclick="showAddUserModal()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">
                <i class="fas fa-plus mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>

        <!-- Back Button -->
        <div class="text-center">
            <a href="index.html" class="inline-flex items-center text-blue-600 hover:text-blue-800 font-semibold">
                <i class="fas fa-arrow-left mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
        </div>
    </div>

    <!-- =============================================== -->
    <!-- MODAL 1: Add/Edit User Modal (hidden by default) -->
    <!-- =============================================== -->
    <div id="userModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-700"></h3>
                <button onclick="closeUserModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="mt-6">
                <form id="userForm" onsubmit="saveUser(event)">
                    <input type="hidden" id="userId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- UID (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-id-card mr-1"></i>UID
                            </label>
                            <div id="uidInputContainer">
                                <input type="text" id="uid" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono hidden"
                                       placeholder="00000000-0000-0000-0000-000000000000"
                                       pattern="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}"
                                       readonly>
                                <div id="uidInfo" class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <p class="text-blue-700">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        UID ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-envelope mr-1"></i>‡∏≠‡∏µ‡πÄ‡∏°‡∏• *
                            </label>
                            <input type="email" id="email" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="example@email.com"
                                   required>
                            <p id="emailEditWarning" class="text-xs text-yellow-600 mt-1 hidden">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                            </p>
                        </div>

                        <!-- Password ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà -->
                        <div class="md:col-span-2" id="passwordContainer">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-lock mr-1"></i>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô *
                            </label>
                            <input type="password" id="password" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà"
                                   minlength="6">
                            <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</p>
                        </div>

                        <!-- Display Name -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-user mr-1"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á *
                            </label>
                            <input type="text" id="displayName" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"
                                   required>
                        </div>

                        <!-- Role -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-user-tag mr-1"></i>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó *
                            </label>
                            <select id="role" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</option>
                                <!-- ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å roles table -->
                            </select>
                        </div>

                        <!-- Grade -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-graduation-cap mr-1"></i>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </label>
                            <select id="grade" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏</option>
                                <!-- ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å grades table -->
                            </select>
                        </div>

                        <!-- Basic Eggs -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-egg mr-1"></i>‡πÑ‡∏Ç‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                            </label>
                            <input type="number" id="totalEggsBasic" min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   value="10">
                        </div>

                        <!-- Premium Eggs -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-gem mr-1"></i>‡πÑ‡∏Ç‡πà‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°
                            </label>
                            <input type="number" id="totalEggsPremium" min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   value="0">
                        </div>

                        <!-- Community Eggs -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-users mr-1"></i>‡πÑ‡∏Ç‡πà‡∏ä‡∏∏‡∏°‡∏ä‡∏ô
                            </label>
                            <input type="number" id="communityEggs" min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   value="0">
                        </div>

                        <!-- Creator Status -->
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-user-check mr-1"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á
                            </label>
                            <div class="flex items-center space-x-4 mt-2">
                                <label class="flex items-center">
                                    <input type="radio" name="creatorStatus" value="true"
                                           class="mr-2 text-blue-600 focus:ring-blue-500">
                                    <span class="text-green-600">
                                        <i class="fas fa-check-circle mr-1"></i>‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á
                                    </span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="creatorStatus" value="false" checked
                                           class="mr-2 text-blue-600 focus:ring-blue-500">
                                    <span class="text-gray-600">
                                        <i class="fas fa-times-circle mr-1"></i>‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Bio -->
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-align-left mr-1"></i>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
                            </label>
                            <textarea id="bio" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                      placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ..."></textarea>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-3 mt-8 pt-4 border-t">
                        <button type="button" onclick="closeUserModal()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button type="submit" id="submitButton"
                                class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center">
                            <i class="fas fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- =============================================== -->
    <!-- MODAL 2: Change Password Modal -->
    <!-- =============================================== -->
    <div id="passwordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="passwordModalTitle" class="text-2xl font-bold text-gray-700">
                    <i class="fas fa-key mr-2"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                </h3>
                <button onclick="closePasswordModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="mt-6">
                <form id="passwordForm" onsubmit="updatePassword(event)">
                    <input type="hidden" id="passwordUserId">
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <i class="fas fa-user mr-1"></i>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                        </label>
                        <p id="passwordUserName" class="text-lg font-semibold text-gray-800"></p>
                        <p id="passwordUserEmail" class="text-sm text-gray-600"></p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <i class="fas fa-lock mr-1"></i>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà *
                        </label>
                        <input type="password" id="newPassword" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà"
                               minlength="6"
                               required>
                        <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <i class="fas fa-lock mr-1"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà *
                        </label>
                        <input type="password" id="confirmPassword" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà"
                               minlength="6"
                               required>
                    </div>
                    
                    <!-- Password Strength Indicator -->
                    <div class="mb-6">
                        <div class="flex justify-between mb-1">
                            <span class="text-xs text-gray-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</span>
                            <span id="passwordStrength" class="text-xs">-</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="passwordStrengthBar" class="bg-red-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-3 mt-8 pt-4 border-t">
                        <button type="button" onclick="closePasswordModal()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button type="submit" id="passwordSubmitButton"
                                class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center">
                            <i class="fas fa-save mr-2"></i>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/supabase-config.js"></script>
    <script src="js/auth_status_manager.js"></script>
    <script src="js/debug-logger.js"></script>
    <script src="js/admin-rpc-checker.js"></script>
    
    <script>
// ===============================================
// Admin Users Manager (Version 8)
// ===============================================

// Global variables
let currentUsers = [];
let currentRoles = [];
let currentGrades = [];
let isEditMode = false;
let currentAdminId = null;

// Debug Logger Wrapper - ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å debug-logger.js ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
function logSuccess(message) {
    if (window.DebugLogger && typeof window.DebugLogger.success === 'function') {
        window.DebugLogger.success(message);
    } else {
        console.log('‚úÖ ' + message);
    }
}

function logError(message) {
    if (window.DebugLogger && typeof window.DebugLogger.error === 'function') {
        window.DebugLogger.error(message);
    } else {
        console.error('‚ùå ' + message);
    }
}

function logInfo(message) {
    if (window.DebugLogger && typeof window.DebugLogger.info === 'function') {
        window.DebugLogger.info(message);
    } else {
        console.info('‚ÑπÔ∏è ' + message);
    }
}

function logWarning(message) {
    if (window.DebugLogger && typeof window.DebugLogger.warning === 'function') {
        window.DebugLogger.warning(message);
    } else {
        console.warn('‚ö†Ô∏è ' + message);
    }
}

// ===============================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Admin Permission
// ===============================================
async function checkAdminPermission() {
    try {
        logInfo('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô...');
        
        const supabase = await window.authStatusManager.getSupabaseClient();
        if (!supabase) {
            logError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Supabase ‡πÑ‡∏î‡πâ');
            return false;
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ session ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const session = await window.authStatusManager.checkCurrentSession();
        if (!session || !session.user) {
            logWarning('‡πÑ‡∏°‡πà‡∏°‡∏µ session ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
            return false;
        }
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const userProfile = await window.authStatusManager.fetchUserProfile(session.user);
        if (!userProfile) {
            logError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ');
            return false;
        }
        
        logInfo(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${userProfile.display_name}, ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ${userProfile.role}`);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
        const isAdmin = userProfile.role === 'admin' || 
                       userProfile.role === 'administrator' || 
                       userProfile.role === 'superadmin';
        
        if (isAdmin) {
            currentAdminId = session.user.id;
            logSuccess('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } else {
            logWarning('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
        }
        
        return isAdmin;
        
    } catch (error) {
        logError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ' + error.message);
        return false;
    }
}

// ===============================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤
// ===============================================
async function initializePage() {
    logInfo('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin Users Manager...');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    const hasPermission = await checkAdminPermission();
    if (!hasPermission) {
        Swal.fire({
            icon: 'error',
            title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á',
            text: '‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
            confirmButtonText: '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard',
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then(() => {
            window.location.href = 'admin_dashboard.html';
        });
        return;
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á auth_status_manager
    if (window.RPCChecker && window.RPCChecker.checkAuthStatusManagerCompatibility) {
        const authCompat = await window.RPCChecker.checkAuthStatusManagerCompatibility();
        if (!authCompat) {
            Swal.fire({
                icon: 'warning',
                title: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå auth_status_manager.js',
                confirmButtonText: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä'
            }).then(() => {
                window.location.reload();
            });
            return;
        }
    }
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Debug Logger
    if (window.DebugLogger && typeof window.DebugLogger.init === 'function') {
        try {
            window.DebugLogger.init();
            logSuccess('DebugLogger ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } catch (e) {
            logWarning('DebugLogger init failed: ' + e.message);
        }
    }
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners
    document.getElementById('searchInput').addEventListener('keyup', filterUsers);
    document.getElementById('roleFilter').addEventListener('change', filterUsers);
    document.getElementById('gradeFilter').addEventListener('change', filterUsers);
    document.getElementById('newPassword')?.addEventListener('input', checkPasswordStrength);
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    await loadMasterData();
    await loadUsers();
    
    logSuccess('‚úÖ ‡∏´‡∏ô‡πâ‡∏≤ Admin Users Manager ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
}

// ===============================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î Master Data
// ===============================================
async function loadMasterData() {
    try {
        const supabase = await window.authStatusManager.getSupabaseClient();
        if (!supabase) {
            throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        }
        
        // ‡πÇ‡∏´‡∏•‡∏î Roles
        const { data: roles, error: rolesError } = await supabase
            .from('roles')
            .select('role_key, role_name_th, role_name_en, is_active')
            .eq('is_active', true)
            .order('display_order', { ascending: true });
        
        if (rolesError) {
            logError('Error loading roles: ' + rolesError.message);
            currentRoles = [
                { role_key: 'student', role_name_th: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' },
                { role_key: 'teacher', role_name_th: '‡∏Ñ‡∏£‡∏π' },
                { role_key: 'admin', role_name_th: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' },
                { role_key: 'content_creator', role_name_th: '‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤' }
            ];
        } else {
            currentRoles = roles || [];
            logSuccess(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Roles ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${currentRoles.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        }
        
        // ‡πÇ‡∏´‡∏•‡∏î Grades
        const { data: grades, error: gradesError } = await supabase
            .from('grades')
            .select('grade_level, grade_name_th, grade_name_en, is_active')
            .eq('is_active', true)
            .order('display_order', { ascending: true });
        
        if (gradesError) {
            logError('Error loading grades: ' + gradesError.message);
            currentGrades = [
                { grade_level: 1, grade_name_th: '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1' },
                { grade_level: 2, grade_name_th: '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2' },
                { grade_level: 3, grade_name_th: '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3' },
                { grade_level: 4, grade_name_th: '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4' },
                { grade_level: 5, grade_name_th: '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5' },
                { grade_level: 6, grade_name_th: '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6' }
            ];
        } else {
            currentGrades = grades || [];
            logSuccess(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Grades ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${currentGrades.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        }
        
        updateDropdownFilters();
        
    } catch (error) {
        logError('Error loading master data: ' + error.message);
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + error.message);
    }
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown filters
function updateDropdownFilters() {
    const roleFilter = document.getElementById('roleFilter');
    roleFilter.innerHTML = '<option value="all">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
    
    currentRoles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.role_key;
        option.textContent = role.role_name_th;
        roleFilter.appendChild(option);
    });
    
    const gradeFilter = document.getElementById('gradeFilter');
    gradeFilter.innerHTML = '<option value="all">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
    
    currentGrades.forEach(grade => {
        const option = document.createElement('option');
        option.value = grade.grade_level;
        option.textContent = grade.grade_name_th;
        gradeFilter.appendChild(option);
    });
}

// ===============================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
// ===============================================
async function loadUsers() {
    const loadingStatus = document.getElementById('loadingStatus');
    const noDataMessage = document.getElementById('noDataMessage');
    const tableBody = document.getElementById('usersTableBody');
    
    loadingStatus.classList.remove('hidden');
    tableBody.innerHTML = '';
    
    try {
        // ‡πÉ‡∏ä‡πâ RPCChecker.callRPCSafely ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const result = await window.RPCChecker.callRPCSafely(
            'get_all_users_for_admin',
            {},
            '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ'
        );
        
        if (!result.success) {
            throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
        }
        
        currentUsers = result.data || [];
        
        updateStats(currentUsers);
        
        if (currentUsers.length > 0) {
            renderUsersTable(currentUsers);
            noDataMessage.classList.add('hidden');
        } else {
            tableBody.innerHTML = '';
            noDataMessage.classList.remove('hidden');
        }
        
        loadingStatus.classList.add('hidden');
        
        logSuccess(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Users ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${currentUsers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        
    } catch (error) {
        loadingStatus.classList.add('hidden');
        logError('Exception in loadUsers: ' + error.message);
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
    }
}

// ===============================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
// ===============================================
function renderUsersTable(users) {
    const tableBody = document.getElementById('usersTableBody');
    tableBody.innerHTML = '';
    
    users.forEach((user) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';
        
        const createdDate = new Date(user.created_at).toLocaleDateString('th-TH', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        
        let roleName = user.role || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏';
        const roleObj = currentRoles.find(r => r.role_key === user.role);
        if (roleObj) {
            roleName = roleObj.role_name_th || roleObj.role_name_en || user.role;
        }
        
        let gradeName = user.grade ? `‡∏ä‡∏±‡πâ‡∏ô ${user.grade}` : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏';
        if (user.grade) {
            const gradeObj = currentGrades.find(g => g.grade_level === user.grade);
            if (gradeObj) {
                gradeName = gradeObj.grade_name_th || gradeObj.grade_name_en || `‡∏ä‡∏±‡πâ‡∏ô ${user.grade}`;
            }
        }
        
        const totalEggs = (user.total_eggs_basic || 0) + (user.total_eggs_premium || 0) + (user.community_eggs || 0);
        const userEmail = user.email || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ)
        const isCurrentUser = user.uid === currentAdminId;
        
        row.innerHTML = `
            <td class="px-6 py-4">
                <div class="flex items-center">
                    ${user.avatar_url ? 
                        `<img src="${user.avatar_url}" alt="${user.display_name}" class="w-10 h-10 rounded-full mr-3">` :
                        `<div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                            <i class="fas fa-user text-blue-600"></i>
                        </div>`
                    }
                    <div>
                        <div class="text-sm font-medium text-gray-900">${user.display_name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}</div>
                        <div class="text-xs text-gray-500 truncate max-w-xs" title="${user.uid}">UID: ${user.uid.substring(0, 8)}...</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-900">
                ${userEmail}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${user.role === 'admin' ? 'bg-red-100 text-red-800' : user.role === 'teacher' ? 'bg-green-100 text-green-800' : user.role === 'content_creator' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                    ${roleName}
                </span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-900">
                ${gradeName}
            </td>
            <td class="px-6 py-4 text-sm text-gray-900">
                <div class="font-semibold">${totalEggs}</div>
                <div class="text-xs text-gray-500">
                    ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô: ${user.total_eggs_basic || 0}, ‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°: ${user.total_eggs_premium || 0}
                </div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-900">
                ${user.avg_rating > 0 ? 
                    `<div class="flex items-center">
                        <span class="font-semibold mr-1">${user.avg_rating.toFixed(1)}</span>
                        <i class="fas fa-star text-yellow-500"></i>
                        <span class="text-xs text-gray-500 ml-1">(${user.total_ratings || 0})</span>
                    </div>` :
                    '<span class="text-gray-400">-</span>'
                }
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <i class="far fa-clock mr-1"></i>${createdDate}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2">
                    <button onclick="editUser('${user.uid}')" 
                            class="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50" 
                            title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                        <i class="fas fa-edit"></i>
                    </button>

                    <button onclick="showChangePasswordModal('${user.uid}', '${user.display_name || user.email}', '${user.email}')" 
                            class="text-green-600 hover:text-green-900 p-1 rounded hover:bg-green-50" 
                            title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                        <i class="fas fa-key"></i>
                    </button>
                    
                    <button onclick="deleteUser('${user.uid}', '${user.display_name || user.email}', ${isCurrentUser})" 
                            class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50 ${isCurrentUser ? 'opacity-50 cursor-not-allowed' : ''}" 
                            title="${isCurrentUser ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ' : '‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}"
                            ${isCurrentUser ? 'disabled' : ''}>
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdowns ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
function updateFormDropdowns() {
    const roleSelect = document.getElementById('role');
    roleSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</option>';
    
    currentRoles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.role_key;
        option.textContent = role.role_name_th;
        roleSelect.appendChild(option);
    });
    
    const gradeSelect = document.getElementById('grade');
    gradeSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏</option>';
    
    currentGrades.forEach(grade => {
        const option = document.createElement('option');
        option.value = grade.grade_level;
        option.textContent = grade.grade_name_th;
        gradeSelect.appendChild(option);
    });
}

// ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç User
async function editUser(userId) {
    const user = currentUsers.find(u => u.uid === userId);
    if (!user) {
        showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
        return;
    }
    
    isEditMode = true;
    document.getElementById('modalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
    document.getElementById('submitButton').innerHTML = '<i class="fas fa-save mr-2"></i>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    
    document.getElementById('userId').value = user.uid;
    document.getElementById('uid').value = user.uid;
    document.getElementById('uid').classList.remove('hidden');
    document.getElementById('uidInfo').classList.add('hidden');
    document.getElementById('uid').setAttribute('readonly', 'readonly');
    
    document.getElementById('passwordContainer').classList.add('hidden');
    document.getElementById('password').removeAttribute('required');
    
    document.getElementById('emailEditWarning').classList.remove('hidden');
    
    document.getElementById('email').value = user.email || '';
    document.getElementById('displayName').value = user.display_name || '';
    document.getElementById('totalEggsBasic').value = user.total_eggs_basic || 0;
    document.getElementById('totalEggsPremium').value = user.total_eggs_premium || 0;
    document.getElementById('communityEggs').value = user.community_eggs || 0;
    document.getElementById('bio').value = user.bio || '';
    
    updateFormDropdowns();
    
    const roleSelect = document.getElementById('role');
    if (user.role) {
        roleSelect.value = user.role;
    }
    
    const gradeSelect = document.getElementById('grade');
    if (user.grade) {
        gradeSelect.value = user.grade;
    } else {
        gradeSelect.value = '';
    }
    
    const creatorStatus = user.creator_status ? 'true' : 'false';
    document.querySelector(`input[name="creatorStatus"][value="${creatorStatus}"]`).checked = true;
    
    document.getElementById('userModal').classList.remove('hidden');
}

// ‡∏õ‡∏¥‡∏î Modal
function closeUserModal() {
    document.getElementById('userModal').classList.add('hidden');
}

// ===============================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
// ===============================================
async function saveUser(event) {
    event.preventDefault();
    
    try {
        const userData = {
            email: document.getElementById('email').value.trim(),
            display_name: document.getElementById('displayName').value.trim() || null,
            role: document.getElementById('role').value,
            grade: document.getElementById('grade').value ? parseInt(document.getElementById('grade').value) : null,
            total_eggs_basic: parseInt(document.getElementById('totalEggsBasic').value) || 0,
            total_eggs_premium: parseInt(document.getElementById('totalEggsPremium').value) || 0,
            community_eggs: parseInt(document.getElementById('communityEggs').value) || 0,
            creator_status: document.querySelector('input[name="creatorStatus"]:checked').value === 'true',
            bio: document.getElementById('bio').value.trim() || null
        };
        
        if (!userData.email || !userData.role) {
            showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏≠‡∏µ‡πÄ‡∏°‡∏•, ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó)');
            return;
        }
        
        let result;
        
        if (isEditMode) {
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
            const existingUid = document.getElementById('uid').value;
            
            if (!existingUid) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö UID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
                return;
            }
            
            result = await window.RPCChecker.callRPCSafely(
                'update_user_admin_simple',
                {
                    p_uid: existingUid,
                    p_email: userData.email,
                    p_display_name: userData.display_name,
                    p_role: userData.role,
                    p_grade: userData.grade,
                    p_total_eggs_basic: userData.total_eggs_basic,
                    p_total_eggs_premium: userData.total_eggs_premium,
                    p_community_eggs: userData.community_eggs,
                    p_creator_status: userData.creator_status,
                    p_bio: userData.bio
                },
                '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ'
            );
            
        } else {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
            const password = document.getElementById('password').value;
            
            if (!password || password.length < 6) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                return;
            }
            
            result = await window.RPCChecker.callRPCSafely(
                'create_user_admin_simple',
                {
                    p_email: userData.email,
                    p_password: password,
                    p_display_name: userData.display_name,
                    p_role: userData.role,
                    p_grade: userData.grade,
                    p_total_eggs_basic: userData.total_eggs_basic,
                    p_total_eggs_premium: userData.total_eggs_premium,
                    p_community_eggs: userData.community_eggs,
                    p_creator_status: userData.creator_status,
                    p_bio: userData.bio
                },
                '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ'
            );
        }
        
        if (!result.success) {
            throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        }
        
        logSuccess(`${isEditMode ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï' : '‡∏™‡∏£‡πâ‡∏≤‡∏á'}‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${userData.display_name || userData.email}`);
        
        closeUserModal();
        await loadUsers();
        
        Swal.fire({
            icon: 'success',
            title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            text: `${isEditMode ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï' : '‡∏™‡∏£‡πâ‡∏≤‡∏á'}‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${userData.display_name || userData.email}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,
            timer: 2000,
            showConfirmButton: false
        });
        
    } catch (error) {
        logError('Error saving user: ' + error.message);
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
    }
}

// ===============================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
// ===============================================

// ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
function showChangePasswordModal(userId, userName, userEmail) {
    document.getElementById('passwordUserId').value = userId;
    document.getElementById('passwordUserName').textContent = userName;
    document.getElementById('passwordUserEmail').textContent = `(${userEmail})`;
    
    document.getElementById('passwordForm').reset();
    document.getElementById('passwordStrength').textContent = '-';
    document.getElementById('passwordStrengthBar').style.width = '0%';
    document.getElementById('passwordStrengthBar').className = 'bg-red-500 h-2 rounded-full';
    
    document.getElementById('passwordModal').classList.remove('hidden');
    
    logInfo(`‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${userName} (${userEmail})`);
}

// ‡∏õ‡∏¥‡∏î Modal ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
function closePasswordModal() {
    document.getElementById('passwordModal').classList.add('hidden');
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
function checkPasswordStrength() {
    const password = document.getElementById('newPassword').value;
    let strength = 0;
    let text = '';
    let barColor = 'bg-red-500';
    
    if (password.length >= 6) strength += 1;
    if (password.length >= 8) strength += 1;
    if (/[A-Z]/.test(password)) strength += 1;
    if (/[0-9]/.test(password)) strength += 1;
    if (/[^A-Za-z0-9]/.test(password)) strength += 1;
    
    switch(strength) {
        case 0:
        case 1:
            text = '‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å';
            barColor = 'bg-red-500';
            break;
        case 2:
            text = '‡∏≠‡πà‡∏≠‡∏ô';
            barColor = 'bg-orange-500';
            break;
        case 3:
            text = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
            barColor = 'bg-yellow-500';
            break;
        case 4:
            text = '‡πÅ‡∏Ç‡πá‡∏á';
            barColor = 'bg-green-500';
            break;
        case 5:
            text = '‡πÅ‡∏Ç‡πá‡∏á‡∏°‡∏≤‡∏Å';
            barColor = 'bg-green-600';
            break;
    }
    
    const percentage = (strength / 5) * 100;
    document.getElementById('passwordStrength').textContent = text;
    document.getElementById('passwordStrengthBar').style.width = `${percentage}%`;
    document.getElementById('passwordStrengthBar').className = `${barColor} h-2 rounded-full`;
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
async function updatePassword(event) {
    event.preventDefault();
    
    const userId = document.getElementById('passwordUserId').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const button = document.getElementById('passwordSubmitButton');
    
    try {
        // Validation
        if (!newPassword || !confirmPassword) {
            showError('‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
            return;
        }
        
        if (newPassword.length < 6) {
            showError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
            return;
        }
        
        // Disable button during process
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô...';
        
        // ‡πÉ‡∏ä‡πâ RPC function reset_user_password_admin
        const result = await window.RPCChecker.callRPCSafely(
            'reset_user_password_admin',
            {
                p_user_id: userId,
                p_new_password: newPassword
            },
            '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ'
        );
        
        if (!result.success) {
            throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
        }
        
        // Success
        closePasswordModal();
        
        Swal.fire({
            icon: 'success',
            title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            text: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
            timer: 2000,
            showConfirmButton: false
        });
        
        logSuccess(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${document.getElementById('passwordUserName').textContent}`);
        
    } catch (error) {
        logError('Error updating password: ' + error.message);
        
        if (error.message.includes('reset_user_password_admin') || error.message.includes('function does not exist')) {
            showError('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô reset_user_password_admin ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            showRPCPasswordCreationInstructions();
        } else {
            showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: ' + error.message);
        }
    } finally {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-save mr-2"></i>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
    }
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á RPC function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö reset password
function showRPCPasswordCreationInstructions() {
    Swal.fire({
        icon: 'info',
        title: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ RPC Function',
        html: `
            <div class="text-left">
                <p>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô <strong>‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ RPC function ‡πÉ‡∏ô Supabase:</p>
                <div class="mt-3 p-2 bg-gray-100 rounded text-xs overflow-auto max-h-60">
                    <pre>
-- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô reset ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin
CREATE OR REPLACE FUNCTION reset_user_password_admin(
    p_user_id uuid,
    p_new_password text
)
RETURNS boolean
SECURITY DEFINER
SET search_path = auth, public
LANGUAGE plpgsql
AS $$
DECLARE
    v_admin_user_id uuid;
BEGIN
    -- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ user ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô admin
    SELECT uid INTO v_admin_user_id 
    FROM public.users 
    WHERE uid = auth.uid() 
    AND role IN ('admin', 'administrator', 'superadmin');
    
    IF v_admin_user_id IS NULL THEN
        RAISE EXCEPTION 'Unauthorized: Admin access required';
    END IF;

    -- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏ô auth.users ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ pgcrypto
    UPDATE auth.users 
    SET encrypted_password = crypt(p_new_password, gen_salt('bf')),
        updated_at = now()
    WHERE id = p_user_id;
    
    RETURN FOUND;
END;
$$;

-- ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
GRANT EXECUTE ON FUNCTION reset_user_password_admin(uuid, text) TO authenticated;
                    </pre>
                </div>
                <p class="mt-3 text-sm text-gray-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ extension "pgcrypto" ‡πÉ‡∏ô database</p>
            </div>
        `,
        confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß',
        showCancelButton: true,
        cancelButtonText: '‡πÄ‡∏õ‡∏¥‡∏î SQL Editor',
        showCloseButton: true
    }).then((result) => {
        if (result.dismiss === 'cancel') {
            window.open('https://supabase.com/dashboard/project/oibubvhuiuurkxhnefsw/sql', '_blank');
        }
    });
}

// ===============================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
// ===============================================
async function deleteUser(userId, userName, isCurrentUser = false) {
    if (isCurrentUser) {
        showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
        return;
    }
    
    const result = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
        html: `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "<b>${userName}</b>" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br>
              <small class="text-red-600">‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    });
    
    if (!result.isConfirmed) return;
    
    try {
        const deleteResult = await window.RPCChecker.callRPCSafely(
            'delete_user_admin_simple',
            { p_user_id: userId },
            '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ'
        );
        
        if (!deleteResult.success) {
            throw new Error(deleteResult.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        }
        
        logSuccess(`‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${userName}`);
        
        await loadUsers();
        
        Swal.fire({
            icon: 'success',
            title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            text: `‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${userName}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`,
            timer: 2000,
            showConfirmButton: false
        });
        
    } catch (error) {
        logError('Error deleting user: ' + error.message);
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
    }
}

// ===============================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
// ===============================================

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
function updateStats(users) {
    const total = users.length;
    const teachers = users.filter(u => u.role === 'teacher').length;
    const creators = users.filter(u => u.creator_status).length;
    const totalEggs = users.reduce((sum, user) => {
        return sum + (user.total_eggs_basic || 0) + (user.total_eggs_premium || 0) + (user.community_eggs || 0);
    }, 0);
    
    document.getElementById('totalUsers').textContent = total;
    document.getElementById('teacherCount').textContent = teachers;
    document.getElementById('creatorCount').textContent = creators;
    document.getElementById('totalEggs').textContent = totalEggs;
}

// ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Users
function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const roleFilter = document.getElementById('roleFilter').value;
    const gradeFilter = document.getElementById('gradeFilter').value;
    
    let filtered = currentUsers;
    
    if (searchTerm) {
        filtered = filtered.filter(user => 
            (user.display_name && user.display_name.toLowerCase().includes(searchTerm)) ||
            (user.email && user.email.toLowerCase().includes(searchTerm)) ||
            (user.uid && user.uid.toLowerCase().includes(searchTerm)) ||
            (user.bio && user.bio.toLowerCase().includes(searchTerm))
        );
    }
    
    if (roleFilter !== 'all') {
        filtered = filtered.filter(user => user.role === roleFilter);
    }
    
    if (gradeFilter !== 'all') {
        const gradeNum = parseInt(gradeFilter);
        filtered = filtered.filter(user => user.grade === gradeNum);
    }
    
    renderUsersTable(filtered);
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
function showError(message) {
    Swal.fire({
        icon: 'error',
        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: message,
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
    });
}

// ===============================================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Header)
// ===============================================
async function adminLogout() {
    try {
        const supabase = window.authStatusManager ? await window.authStatusManager.getSupabaseClient() : null;
        if (supabase) {
            await supabase.auth.signOut();
        }
        window.location.href = 'index.html';
    } catch (error) {
        console.error('Logout error:', error);
        window.location.href = 'index.html';
    }
}

// ===============================================
// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°
// ===============================================
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üìÅ Admin Users Manager (Version 8) Initializing...');
    
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    setTimeout(async () => {
        await initializePage();
    }, 500);
});

// Export functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
window.AdminUsersManager = {
    initializePage,
    loadUsers,
    saveUser,
    deleteUser,
    updatePassword,
    checkRPCStatus
};
    </script>
 
    <style>
        .hover-scale {
            transition: transform 0.2s ease-in-out;
        }
        .hover-scale:hover {
            transform: translateY(-2px);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            ring: 2px;
        }
        
        #usersTableBody::-webkit-scrollbar {
            width: 6px;
        }
        
        #usersTableBody::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        #usersTableBody::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        #usersTableBody::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .avatar-fallback {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #userModal > div, #passwordModal > div {
            animation: modalFadeIn 0.3s ease-out;
        }
        
        tbody tr {
            transition: background-color 0.2s ease;
        }
        
        tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .hidden {
            display: none;
        }
    </style>

</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à | Rainbow OrcaKids</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- App CSS -->
    <link rel="stylesheet" href="css/app.css">
    
    <style>
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ mission detail */
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .debug-log {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        .egg-animation {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
    </style>
    
</head>
<body class="font-sarabun">
    <!-- Navigation bar ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ js/nav.js -->
    
    <div class="app-container">
        <div class="max-w-4xl mx-auto mt-10 p-6">
            <h1 id="missionTitle" class="text-3xl font-bold text-blue-700 mb-6 border-b-2 border-blue-200 pb-3">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...
            </h1>
            
            <div id="loadingStatus" class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-gray-700">
                ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...
            </div>

            <!-- Egg Reward Notification (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏Ç‡πà) -->
            <div id="eggNotification" class="hidden fixed top-4 right-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-xl shadow-2xl z-50">
                <div class="flex items-center">
                    <div class="mr-3">
                        <i class="fas fa-egg text-3xl egg-animation"></i>
                    </div>
                    <div>
                        <div class="font-bold text-lg">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</div>
                        <div class="text-sm">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <span id="eggsAwarded" class="font-bold">0 ‡πÑ‡∏Ç‡πà</span></div>
                        <div class="text-xs mt-1">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="newEggsTotal">0</span> ‡πÑ‡∏Ç‡πà</div>
                    </div>
                </div>
            </div>
            
            <div id="missionDetail" class="hidden">
                
                <!-- Video Container -->
                <div id="videoContainer" class="aspect-video bg-gray-700 rounded-lg overflow-hidden mb-4 shadow-lg">
                    <!-- Video will be loaded here -->
                </div>
                
                <!-- Progress Status Section (Phase 2.5) -->
                <div id="progressStatus" class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-blue-600"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Video Watch Status -->
                        <div id="videoStatus" class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                <i class="fas fa-video text-blue-600"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-700">‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ Story</div>
                                <div id="videoStatusText" class="text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
                            </div>
                        </div>
                        
                        <!-- Submission Status -->
                        <div id="submissionStatus" class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-3">
                                <i class="fas fa-paper-plane text-green-600"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-700">‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</div>
                                <div id="submissionStatusText" class="text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Egg Reward Display -->
                    <div id="eggRewardDisplay" class="mb-4 p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200 hidden">
                        <div class="flex items-center">
                            <div class="mr-3">
                                <i class="fas fa-egg text-2xl text-yellow-500"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-700">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏Ç‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ</div>
                                <div class="text-lg font-bold text-yellow-600">
                                    <span id="missionEggReward">0</span> ‡πÑ‡∏Ç‡πà
                                </div>
                                <div class="text-xs text-gray-500">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÑ‡∏Ç‡πà!</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mt-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                            <span id="overallProgress" class="font-bold">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            <span id="progressText">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏•‡∏¢!</span>
                        </div>
                    </div>
                </div>
                
                <!-- Mission Info -->
                <p id="courseInfo" class="text-sm text-gray-500 mb-2"></p>

                <h2 class="text-xl font-bold text-gray-700 mt-6 mb-2 border-b pb-1">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h2>
                <div id="missionPrompt" class="bg-blue-50 p-4 rounded-lg border border-blue-200 text-gray-700 whitespace-pre-wrap">
                    <!-- Mission prompt will be loaded here -->
                </div>

                <h2 class="text-xl font-bold text-green-700 mt-8 mb-4 border-b pb-1">‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô (‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)</h2>
                <form id="submissionForm" class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <div class="mb-4">
                        <label for="videoFile" class="block text-gray-700 font-semibold mb-2">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ú‡∏•‡∏á‡∏≤‡∏ô (.mp4, .mov)</label>
                        <input type="file" id="videoFile" name="videoFile" accept="video/*" required 
                               class="form-input w-full">
                    </div>
                    
                    <div id="uploadStatus" class="text-sm mb-4">
                        <p class="text-red-600">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</p>
                    </div>

                    <button type="submit" id="submitBtn" disabled
                            class="btn-primary w-full py-3 disabled:opacity-50">
                        üîí ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
                    </button>
                    
                    <!-- Success Message (hidden by default) -->
                    <div id="successMessage" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                        <i class="fas fa-check-circle text-green-500 text-3xl mb-2"></i>
                        <h3 class="text-lg font-bold text-green-700 mb-1">‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                        <p class="text-green-600">‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏Ç‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>
                        <div class="mt-2">
                            <a href="profile.html" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-user mr-1"></i> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÑ‡∏Ç‡πà
                            </a>
                        </div>
                    </div>
                </form>
                
            </div>
            
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Scripts - ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -->
    <script src="js/supabase-config.js"></script>
    <script src="js/auth_status_manager.js"></script>
    <script src="js/nav.js"></script>
    <script src="js/debug-manager.js"></script>

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° progress.js ‡πÅ‡∏•‡∏∞ eggs.js ‡∏Å‡πà‡∏≠‡∏ô main script -->
    <script src="js/progress.js"></script>
    <script src="js/eggs.js"></script>

    <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô script ‡∏Ç‡∏≠‡∏á mission_detail.html ‡πÄ‡∏õ‡πá‡∏ô: -->
<script>
    // Mission detail specific JavaScript code
    // ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö missions.html ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    const loadingStatus = document.getElementById('loadingStatus');
    const missionDetail = document.getElementById('missionDetail');
    const submitBtn = document.getElementById('submitBtn');
    let currentMissionId = null;
    let currentMissionEggs = 0;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö log ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° debug
    function missionLog(message, type = 'info') {
        const logMessage = `[MISSION-DETAIL] ${message}`;
        
        if (window.DebugManager && window.DebugManager.isDebugMode) {
            if (type === 'error') {
                console.error(logMessage);
            } else if (type === 'warning') {
                console.warn(logMessage);
            } else {
                console.log(logMessage);
            }
        } else if (type === 'error') {
            console.error(logMessage);
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á mission ID ‡∏à‡∏≤‡∏Å URL
    function getMissionIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
    async function fetchMissionDetails(missionId) {
        missionLog(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ID: ${missionId}`, 'info');
        
        try {
            // ‡πÉ‡∏ä‡πâ getSupabaseClient ‡∏à‡∏≤‡∏Å auth_status_manager.js ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const supabase = window.getSupabaseClient ? await window.getSupabaseClient() : null;
            
            if (!supabase) {
                missionLog('Supabase client not available', 'error');
                loadingStatus.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <strong class="font-bold">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</strong>
                        <span class="block sm:inline"> ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</span>
                    </div>
                `;
                return null;
            }
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• lessons ‡πÅ‡∏•‡∏∞ courses
            const { data: mission, error } = await supabase
                .from('missions')
                .select(`
                    *,
                    lessons (*, courses (*))
                `)
                .eq('mission_id', missionId)
                .single();

            if (error) {
                missionLog(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ${error.message}`, 'error');
                loadingStatus.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <strong class="font-bold">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</strong>
                        <span class="block sm:inline"> ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏î‡πâ: ${error.message}</span>
                    </div>
                `;
                return null;
            }

            missionLog(`‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${mission.mission_title}`, 'success');
            return mission;
        } catch (error) {
            missionLog(`Exception ‡πÉ‡∏ô fetchMissionDetails: ${error.message}`, 'error');
            return null;
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
    function displayMissionDetails(mission) {
        if (!mission) return;
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        document.getElementById('missionTitle').textContent = mission.mission_title;
        document.getElementById('courseInfo').textContent = 
            `‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: ${mission.lessons?.courses?.title || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} | ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${mission.lessons?.lesson_title || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`;
        document.getElementById('missionPrompt').textContent = mission.prompt_template;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏Ç‡πà‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
        currentMissionEggs = mission.egg_reward || 10;
        if (currentMissionEggs > 0) {
            document.getElementById('missionEggReward').textContent = currentMissionEggs;
            document.getElementById('eggRewardDisplay').classList.remove('hidden');
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const videoContainer = document.getElementById('videoContainer');
        if (mission.lessons?.video_url_story) {
            videoContainer.innerHTML = `
                <video controls class="w-full h-full object-contain bg-black">
                    <source src="${mission.lessons.video_url_story}" type="video/mp4">
                    ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
                </video>
            `;
        } else {
            videoContainer.innerHTML = `
                <div class="w-full h-full flex items-center justify-center text-white">
                    <div class="text-center">
                        <i class="fas fa-video-slash text-4xl mb-2"></i>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</p>
                    </div>
                </div>
            `;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• mission detail
        missionDetail.classList.remove('hidden');
        loadingStatus.classList.add('hidden');
        
        missionLog('‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ progress ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    async function checkUserProgress(missionId) {
        missionLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...', 'info');
        
        try {
            const supabase = window.getSupabaseClient ? await window.getSupabaseClient() : null;
            
            if (!supabase) {
                updateProgressUI(false);
                return;
            }
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                missionLog('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô', 'warning');
                updateProgressUI(false);
                return;
            }
            
            const userId = session.user.id;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏à‡∏≤‡∏Å student_progress)
            const { data: progressData, error: progressError } = await supabase
                .from('student_progress')
                .select('*')
                .eq('student_uid', userId)
                .eq('mission_id', missionId)
                .maybeSingle();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏à‡∏≤‡∏Å student_submissions)
            const { data: submission, error: submissionError } = await supabase
                .from('student_submissions')
                .select('*')
                .eq('student_uid', userId)
                .eq('mission_id', missionId)
                .maybeSingle();
            
            if (progressError) {
                missionLog(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á progress: ${progressError.message}`, 'error');
            }
            
            if (submissionError) {
                missionLog(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á submission: ${submissionError.message}`, 'error');
            }
            
            updateProgressUI(true, {
                progressData: progressData,
                hasSubmitted: !!submission,
                submissionData: submission
            });
        } catch (error) {
            missionLog(`Exception ‡πÉ‡∏ô checkUserProgress: ${error.message}`, 'error');
            updateProgressUI(false);
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
    function updateProgressUI(isLoggedIn, progress = null) {
        const videoStatusText = document.getElementById('videoStatusText');
        const submissionStatusText = document.getElementById('submissionStatusText');
        const progressBar = document.getElementById('progressBar');
        const overallProgress = document.getElementById('overallProgress');
        const progressText = document.getElementById('progressText');
        const uploadStatus = document.getElementById('uploadStatus');
        const submitBtn = document.getElementById('submitBtn');
        
        if (!isLoggedIn) {
            videoStatusText.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
            submissionStatusText.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
            overallProgress.textContent = '0%';
            progressBar.style.width = '0%';
            progressText.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏•‡∏¢!';
            uploadStatus.innerHTML = '<p class="text-red-600">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</p>';
            submitBtn.disabled = true;
            submitBtn.textContent = 'üîí ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô';
            return;
        }
        
        if (!progress) {
            videoStatusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            submissionStatusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            return;
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
        if (progress.progressData && progress.progressData.is_video_watched) {
            videoStatusText.innerHTML = '<span class="text-green-600">‚úÖ ‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>';
        } else {
            videoStatusText.innerHTML = '<span class="text-yellow-600">‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</span>';
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
        if (progress.hasSubmitted) {
            const submittedDate = new Date(progress.submissionData.created_at).toLocaleDateString('th-TH');
            submissionStatusText.innerHTML = `<span class="text-green-600">‚úÖ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (${submittedDate})</span>`;
            submitBtn.disabled = true;
            submitBtn.textContent = '‚úÖ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
            uploadStatus.innerHTML = '<p class="text-green-600">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>';
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏Ç‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (progress.submissionData.eggs_basic_received > 0) {
                uploadStatus.innerHTML += `
                    <p class="text-yellow-600 mt-1">
                        <i class="fas fa-egg mr-1"></i> 
                        ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${progress.submissionData.eggs_basic_received} ‡πÑ‡∏Ç‡πà‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ
                    </p>
                `;
            }
        } else {
            submissionStatusText.innerHTML = '<span class="text-red-600">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</span>';
            submitBtn.disabled = false;
            submitBtn.textContent = 'üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠';
            uploadStatus.innerHTML = '<p class="text-gray-600">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ú‡∏•‡∏á‡∏≤‡∏ô (.mp4, .mov) ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100MB</p>';
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì progress ‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°
        let progressPercentage = 0;
        if (progress.progressData && progress.progressData.is_video_watched) progressPercentage += 50;
        if (progress.hasSubmitted) progressPercentage += 50;
        
        overallProgress.textContent = `${progressPercentage}%`;
        progressBar.style.width = `${progressPercentage}%`;
        
        if (progressPercentage === 100) {
            progressText.innerHTML = '<span class="text-green-600">üéâ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!</span>';
        } else if (progressPercentage === 50) {
            progressText.textContent = '‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô!';
        } else {
            progressText.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏•‡∏¢!';
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏Ç‡πà
    function showEggNotification(eggsAwarded, newTotal) {
        const notification = document.getElementById('eggNotification');
        document.getElementById('eggsAwarded').textContent = `${eggsAwarded} ‡πÑ‡∏Ç‡πà`;
        document.getElementById('newEggsTotal').textContent = newTotal;
        
        notification.classList.remove('hidden');
        notification.classList.add('animate-bounce');
        
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
            notification.classList.add('hidden');
            notification.classList.remove('animate-bounce');
        }, 5000);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
    function setupSubmissionForm(missionId) {
        const form = document.getElementById('submissionForm');
        const videoFileInput = document.getElementById('videoFile');
        const successMessage = document.getElementById('successMessage');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const supabase = window.getSupabaseClient ? await window.getSupabaseClient() : null;
                if (!supabase) {
                    alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                    return;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô');
                    window.location.href = 'login_supabase.html';
                    return;
                }
                
                const userId = session.user.id;
                const file = videoFileInput.files[0];
                if (!file) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠');
                    return;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
                const validTypes = ['video/mp4', 'video/quicktime', 'video/x-msvideo'];
                if (!validTypes.includes(file.type)) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (MP4, MOV, AVI)');
                    return;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100MB)
                if (file.size > 100 * 1024 * 1024) {
                    alert('‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100MB');
                    return;
                }
                
                // Disable ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
                
                try {
                    missionLog('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠...', 'info');
                    
                    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á Supabase Storage
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
                    const filePath = `submissions/${userId}/${fileName}`;
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('videos')
                        .upload(filePath, file);
                    
                    if (uploadError) throw uploadError;
                    
                    // ‡∏î‡∏∂‡∏á URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                    const { data: { publicUrl } } = supabase.storage
                        .from('videos')
                        .getPublicUrl(filePath);
                    
                    missionLog(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${publicUrl}`, 'success');
                    
                    // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• student_submissions
                    const { data: submissionData, error: submissionError } = await supabase
                        .from('student_submissions')
                        .insert({
                            student_uid: userId,
                            mission_id: missionId,
                            video_url: publicUrl,
                            status: 'pending',
                            created_at: new Date().toISOString()
                        })
                        .select()
                        .single();
                    
                    if (submissionError) throw submissionError;
                    
                    missionLog(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å submission ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${submissionData.submission_id}`, 'success');
                    
                    // 2. ‡πÉ‡∏ä‡πâ ProgressSystem ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                    // (‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ ProgressSystem ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
                    if (typeof ProgressSystem !== 'undefined') {
                        missionLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å progress ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÑ‡∏Ç‡πà...', 'info');
                        
                        const progressResult = await ProgressSystem.recordProgress(
                            userId,
                            missionId,
                            'completed',
                            { 
                                submission_time: new Date().toISOString(),
                                submission_id: submissionData.submission_id 
                            }
                        );
                        
                        if (!progressResult.success) {
                            missionLog(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å progress ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${progressResult.error}`, 'error');
                        } else {
                            missionLog('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å progress ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                            
                            // 3. ‡∏£‡∏±‡∏ö‡πÑ‡∏Ç‡πà‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
                            const eggsResult = await ProgressSystem.awardEggsForCompletion(userId, missionId);
                            
                            if (eggsResult.success) {
                                missionLog(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏Ç‡πà: ${eggsResult.eggsAwarded} ‡∏ü‡∏≠‡∏á`, 'success');
                                
                                // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï submission ‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏Ç‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                                await supabase
                                    .from('student_submissions')
                                    .update({
                                        eggs_basic_received: eggsResult.eggsAwarded
                                    })
                                    .eq('submission_id', submissionData.submission_id);
                                
                                // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏Ç‡πà
                                showEggNotification(eggsResult.eggsAwarded, eggsResult.newTotal);
                            }
                        }
                    } else {
                        missionLog('ProgressSystem ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
                    }
                    
                    // 5. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                    form.classList.add('hidden');
                    successMessage.classList.remove('hidden');
                    
                    // 6. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    setTimeout(() => {
                        checkUserProgress(missionId);
                    }, 1000);
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    missionLog(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô: ${error.message}`, 'error');
                    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô: ' + error.message);
                    
                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠';
                }
            } catch (error) {
                missionLog(`Exception ‡πÉ‡∏ô form submit: ${error.message}`, 'error');
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
    async function setupVideoTracking(missionId) {
        const videoElement = document.querySelector('video');
        if (!videoElement) return;
        
        let hasRecordedProgress = false;
        
        videoElement.addEventListener('timeupdate', async () => {
            // ‡∏ñ‡πâ‡∏≤‡∏î‡∏π‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß 80% ‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏î‡∏π‡∏à‡∏ö
            if (!hasRecordedProgress && videoElement.currentTime >= videoElement.duration * 0.8) {
                hasRecordedProgress = true;
                
                try {
                    const supabase = window.getSupabaseClient ? await window.getSupabaseClient() : null;
                    if (!supabase) return;
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) return;
                    
                    const userId = session.user.id;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô student_progress
                    try {
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ record ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        const { data: existingProgress } = await supabase
                            .from('student_progress')
                            .select('progress_id')
                            .eq('student_uid', userId)
                            .eq('mission_id', missionId)
                            .maybeSingle();
                        
                        if (existingProgress) {
                            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï record ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
                            const { error } = await supabase
                                .from('student_progress')
                                .update({
                                    is_video_watched: true,
                                    last_video_watch_time: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                })
                                .eq('progress_id', existingProgress.progress_id);
                            
                            if (!error) {
                                missionLog('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)', 'success');
                                checkUserProgress(missionId);
                            }
                        } else {
                            // ‡∏™‡∏£‡πâ‡∏≤‡∏á record ‡πÉ‡∏´‡∏°‡πà
                            const { error } = await supabase
                                .from('student_progress')
                                .insert({
                                    student_uid: userId,
                                    mission_id: missionId,
                                    is_video_watched: true,
                                    last_video_watch_time: new Date().toISOString(),
                                    video_views_count: 1,
                                    is_submitted: false,
                                    submission_count: 0,
                                    updated_at: new Date().toISOString()
                                });
                            
                            if (!error) {
                                missionLog('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÉ‡∏´‡∏°‡πà)', 'success');
                                checkUserProgress(missionId);
                            }
                        }
                    } catch (error) {
                        missionLog(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ${error.message}`, 'error');
                    }
                } catch (error) {
                    missionLog(`Exception ‡πÉ‡∏ô video tracking: ${error.message}`, 'error');
                }
            }
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
    document.addEventListener('DOMContentLoaded', async () => {
        missionLog('DOM Content Loaded. Initializing mission detail page...');
        
        try {
            // ‡∏î‡∏∂‡∏á mission ID ‡∏à‡∏≤‡∏Å URL
            currentMissionId = getMissionIdFromURL();
            
            if (!currentMissionId) {
                loadingStatus.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <strong class="font-bold">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</strong>
                        <span class="block sm:inline"> ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏ô URL</span>
                    </div>
                `;
                missionLog('‡πÑ‡∏°‡πà‡∏û‡∏ö Mission ID ‡πÉ‡∏ô URL', 'error');
                return;
            }
            
            missionLog(`Mission ID ‡∏à‡∏≤‡∏Å URL: ${currentMissionId}`, 'info');
            
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô missions.html)
            setTimeout(async () => {
                try {
                    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
                    const mission = await fetchMissionDetails(currentMissionId);
                    
                    if (mission) {
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
                        displayMissionDetails(mission);
                        
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                        await checkUserProgress(currentMissionId);
                        
                        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
                        setupSubmissionForm(currentMissionId);
                        
                        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
                        setupVideoTracking(currentMissionId);
                    }
                } catch (error) {
                    missionLog(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤: ${error.message}`, 'error');
                }
            }, 1000);
            
        } catch (error) {
            missionLog(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤: ${error.message}`, 'error');
            loadingStatus.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    <strong class="font-bold">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</strong>
                    <span class="block sm:inline"> ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</span>
                </div>
            `;
        }
    });
</script>
    
</body>
</html>

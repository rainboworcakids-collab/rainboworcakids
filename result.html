<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Psychomatrix - RainbowOrcaKids</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/PsychomatrixStyle.css">
    
    <!-- Favicon -->
    <link rel="icon" href="images/PsychomatixAnalize.png" type="image/png">
    
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Scripts ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö -->
    <script src="js/supabase-config.js"></script>
    <script src="js/debug-logger.js"></script>
</head>
<body class="tw-bg-gray-100 tw-p-4">
    <div class="tw-max-w-4xl tw-mx-auto tw-mt-6">
        <!-- Header -->
        <div class="tw-text-center tw-mb-6 tw-p-4 tw-bg-gradient-to-r tw-from-blue-600 tw-to-purple-600 tw-rounded-lg tw-shadow-lg">
            <h1 class="tw-text-3xl tw-font-bold tw-text-white tw-mb-2">üîÆ Psychomatrix Analysis</h1>
            <p class="tw-text-blue-100">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</p>
        </div>
        
        <!-- Tabs -->
        <div class="tw-flex tw-border-b tw-border-gray-300">
            <button class="tablink active" onclick="switchTab('Main', this)">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
            <button class="tablink" onclick="switchTab('Explained', this)">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</button>
            <button class="tablink" onclick="switchTab('SQL', this)">SQL Results</button>
        </div>

        <!-- Main Tab - ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå -->
        <div id="Main" class="tabcontent active tw-bg-white tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <h2 class="tw-text-2xl tw-font-bold tw-text-center tw-mb-6">
                <img src="images/PsychomatixAnalize.png" 
                     alt="Logo" class="tw-h-16 tw-w-16 tw-inline tw-mr-3">
                ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Psychomatrix
            </h2>
            
            <div id="loading-message" class="tw-text-center tw-py-8">
                <div class="tw-inline-block tw-animate-spin tw-rounded-full tw-h-12 tw-w-12 tw-border-b-2 tw-border-blue-600"></div>
                <p class="tw-mt-4 tw-text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
            
            <div id="result-content" class="tw-hidden">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å render ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
        </div>

        <!-- Explained Tab - ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ -->
        <div id="Explained" class="tabcontent tw-bg-white tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <div id="explained-content">
                <p class="tw-text-gray-500 tw-text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
            </div>
        </div>

        <!-- SQL Tab - ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• SQL Query -->
        <div id="SQL" class="tabcontent tw-bg-gray-900 tw-text-gray-100 tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <h3 class="tw-text-xl tw-font-bold tw-mb-4">SQL Query Results</h3>
            <div id="sql-content">
                <pre class="tw-text-sm tw-whitespace-pre-wrap">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SQL...</pre>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = window.SUPABASE_URL || 'https://oibubvhuiuurkxhnefsw.supabase.co';
        const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Supabase client
        const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

        // ==================== UTILITY FUNCTIONS ====================
        function switchTab(tabName, el) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tablink').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            el.classList.add('active');
        }

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                birth_date: params.get('birth_date') || '',
                full_name: params.get('full_name') || '',
                id_card: params.get('id_card') || ''
            };
        }

        // ==================== SQL QUERY FUNCTIONS ====================
        async function queryLifePathFromSupabase(rootNumber) {
            try {
                console.log(`üìä Querying Supabase for LifePath WHERE root_number = ${rootNumber}`);
                
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/numerology_search_index?` + 
                    `element_type=eq.LifePath&root_number=eq.${rootNumber}&select=*`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Supabase query failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`‚úÖ Supabase returned ${data.length} records`);
                
                return data[0]; // ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡πÅ‡∏Ñ‡πà 1 record
            } catch (error) {
                console.error(`‚ùå Supabase query error: ${error.message}`);
                return null;
            }
        }

        async function queryDestinyFromSupabase(destinyNumber) {
            try {
                console.log(`üìä Querying Supabase for Destiny WHERE id = ${destinyNumber}`);
                
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/numerology_search_index?` + 
                    `element_type=eq.Destiny&id=eq.${destinyNumber}&select=*`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Supabase query failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`‚úÖ Supabase returned ${data.length} records`);
                
                return data[0];
            } catch (error) {
                console.error(`‚ùå Supabase query error: ${error.message}`);
                return null;
            }
        }

        // ==================== GITHUB CONTENT FETCH ====================
        async function fetchContentFromGitHub(path) {
            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ path ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ / ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const cleanPath = path.startsWith('/') ? path : `/${path}`;
                const url = `https://rainboworcakids-collab.github.io/rainboworcakids${cleanPath}`;
                
                console.log(`üåê Fetching GitHub content: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`GitHub fetch failed: ${response.status} ${response.statusText}`);
                }
                
                const html = await response.text();
                console.log(`‚úÖ GitHub content fetched (${html.length} bytes)`);
                
                return html;
            } catch (error) {
                console.error(`‚ùå GitHub fetch error: ${error.message}`);
                return `<div class="tw-text-red-500 tw-p-4 tw-border tw-border-red-200 tw-rounded">
                    <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏î‡πâ</p>
                    <p class="tw-text-sm">${error.message}</p>
                    <p class="tw-text-sm">Path: ${path}</p>
                </div>`;
            }
        }

        // ==================== EDGE FUNCTION CALL ====================
        async function callPsychomatrixCalculate(birthDate) {
            try {
                const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/psychomatrix-calculate`;
                
                console.log(`üì° Calling Edge Function: ${EDGE_FUNCTION_URL}`);
                console.log(`üìÖ Birth Date: ${birthDate}`);
                
                const response = await fetch(EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ birth_date: birthDate })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Edge Function error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log(`‚úÖ Edge Function returned:`, data);
                
                return data;
            } catch (error) {
                console.error(`‚ùå Edge Function call failed: ${error.message}`);
                throw error;
            }
        }

        // ==================== RENDERING FUNCTIONS ====================
        function renderMainResult(edgeResult, lifePathData, destinyData) {
            if (!edgeResult) {
                return `<div class="tw-text-red-500 tw-text-center tw-p-4">
                    <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p>
                </div>`;
            }
            
            const { birth_date, destiny_number, life_path_number, life_path_meaning } = edgeResult;
            
            return `
                <div class="tw-space-y-6">
                    <!-- Header -->
                    <div class="tw-text-center tw-mb-8">
                        <h3 class="tw-text-2xl tw-font-bold tw-text-gray-800">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î</h3>
                        <p class="tw-text-3xl tw-font-semibold tw-text-blue-600 tw-mt-2">${birth_date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                    </div>
                    
                    <!-- Numbers Summary -->
                    <div class="tw-grid md:tw-grid-cols-2 tw-gap-6">
                        <!-- Destiny Card -->
                        <div class="tw-bg-gradient-to-r tw-from-blue-50 tw-to-blue-100 tw-border-2 tw-border-blue-200 tw-rounded-xl tw-p-6 tw-shadow">
                            <h4 class="tw-text-lg tw-font-bold tw-text-blue-800 tw-mb-2">‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏£‡∏∞‡∏Å‡∏¥‡∏à (Destiny)</h4>
                            <div class="tw-flex tw-items-center">
                                <div class="tw-text-5xl tw-font-bold tw-text-blue-600 tw-mr-4">${destiny_number || '-'}</div>
                                <div>
                                    <p class="tw-text-gray-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤</p>
                                    ${destinyData ? `<p class="tw-text-sm tw-text-gray-500">${destinyData.title || ''}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Life Path Card -->
                        <div class="tw-bg-gradient-to-r tw-from-green-50 tw-to-green-100 tw-border-2 tw-border-green-200 tw-rounded-xl tw-p-6 tw-shadow">
                            <h4 class="tw-text-lg tw-font-bold tw-text-green-800 tw-mb-2">‡πÄ‡∏•‡∏Ç‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (Life Path)</h4>
                            <div class="tw-flex tw-items-center">
                                <div class="tw-text-5xl tw-font-bold tw-text-green-600 tw-mr-4">${life_path_number || '-'}</div>
                                <div>
                                    <p class="tw-text-gray-600">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                                    ${lifePathData ? `<p class="tw-text-sm tw-text-gray-500">${lifePathData.title || ''}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Life Path Meaning -->
                    ${life_path_meaning ? `
                    <div class="tw-bg-yellow-50 tw-border-l-4 tw-border-yellow-400 tw-p-4 tw-rounded">
                        <h4 class="tw-font-bold tw-text-yellow-800 tw-mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï:</h4>
                        <p class="tw-text-gray-700">${life_path_meaning}</p>
                    </div>
                    ` : ''}
                    
                    <!-- Action Buttons -->
                    <div class="tw-flex tw-justify-center tw-space-x-4 tw-mt-8">
                        <button onclick="loadLifePathContent(${life_path_number})" 
                                class="tw-bg-green-500 hover:tw-bg-green-600 tw-text-white tw-font-bold tw-py-3 tw-px-6 tw-rounded-lg tw-transition">
                            üìñ ‡∏î‡∏π‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
                        </button>
                        <button onclick="loadDestinyContent(${destiny_number})" 
                                class="tw-bg-blue-500 hover:tw-bg-blue-600 tw-text-white tw-font-bold tw-py-3 tw-px-6 tw-rounded-lg tw-transition">
                            üîÆ ‡∏î‡∏π‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏£‡∏∞‡∏Å‡∏¥‡∏à
                        </button>
                    </div>
                    
                    <!-- Links to GitHub Content -->
                    <div class="tw-mt-6 tw-p-4 tw-bg-gray-50 tw-rounded">
                        <h4 class="tw-font-bold tw-text-gray-800 tw-mb-2">üìÅ GitHub Content Paths:</h4>
                        <ul class="tw-text-sm">
                            <li>Life Path: <code>${lifePathData ? lifePathData.html_path : 'N/A'}</code></li>
                            <li>Destiny: <code>${destinyData ? destinyData.html_path : 'N/A'}</code></li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderSQLResults(lifePathQuery, destinyQuery) {
            return `
=== SQL QUERY 1: Life Path (root_number = 6) ===
SELECT * FROM numerology_search_index 
WHERE element_type = 'LifePath' AND root_number = 6

Result:
${lifePathQuery ? JSON.stringify(lifePathQuery, null, 2) : 'No data found'}

=== SQL QUERY 2: Destiny (id = destiny_number) ===
SELECT * FROM numerology_search_index 
WHERE element_type = 'Destiny' AND id = ${destinyQuery ? destinyQuery.id : 'N/A'}

Result:
${destinyQuery ? JSON.stringify(destinyQuery, null, 2) : 'No data found'}

=== GITHUB PATHS ===
Life Path HTML Path: ${lifePathQuery ? lifePathQuery.html_path : 'N/A'}
Destiny HTML Path: ${destinyQuery ? destinyQuery.html_path : 'N/A'}
            `;
        }

        // ==================== LOADING FUNCTIONS ====================
        async function loadLifePathContent(lifePathNumber) {
            try {
                console.log(`Loading Life Path content for number: ${lifePathNumber}`);
                
                // Query Supabase ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ html_path
                const lifePathData = await queryLifePathFromSupabase(lifePathNumber);
                
                if (!lifePathData || !lifePathData.html_path) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                    return;
                }
                
                // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å GitHub
                const content = await fetchContentFromGitHub(lifePathData.html_path);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö Explained
                document.getElementById('explained-content').innerHTML = content;
                
                // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö Explained
                switchTab('Explained', document.querySelector('[onclick*="Explained"]'));
                
                console.log('Life Path content loaded successfully');
            } catch (error) {
                console.error(`Failed to load Life Path content: ${error.message}`);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤');
            }
        }

        async function loadDestinyContent(destinyNumber) {
            try {
                console.log(`Loading Destiny content for number: ${destinyNumber}`);
                
                // Query Supabase ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ html_path
                const destinyData = await queryDestinyFromSupabase(destinyNumber);
                
                if (!destinyData || !destinyData.html_path) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏£‡∏∞‡∏Å‡∏¥‡∏à‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                    return;
                }
                
                // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å GitHub
                const content = await fetchContentFromGitHub(destinyData.html_path);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö Explained
                document.getElementById('explained-content').innerHTML = content;
                
                // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö Explained
                switchTab('Explained', document.querySelector('[onclick*="Explained"]'));
                
                console.log('Destiny content loaded successfully');
            } catch (error) {
                console.error(`Failed to load Destiny content: ${error.message}`);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤');
            }
        }

        // ==================== MAIN EXECUTION ====================
        async function initializePage() {
            try {
                console.log('=== INITIALIZING RESULT PAGE ===');
                
                let edgeResult = null;
                
                // 1. ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å sessionStorage ‡∏Å‡πà‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å Psychomatrix.js)
                const sessionData = sessionStorage.getItem('psychomatrixResult');
                if (sessionData) {
                    try {
                        edgeResult = JSON.parse(sessionData);
                        console.log('üìÇ Loaded data from sessionStorage:', edgeResult);
                    } catch (parseError) {
                        console.error('Failed to parse sessionStorage data:', parseError);
                    }
                }
                
                // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô sessionStorage ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å URL parameters
                if (!edgeResult || !edgeResult.success) {
                    const params = getUrlParams();
                    console.log(`üìã URL Parameters:`, params);
                    
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ birth_date ‡πÉ‡∏ô URL ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Edge Function
                    if (params.birth_date) {
                        edgeResult = await callPsychomatrixCalculate(params.birth_date);
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏î‡πÜ
                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Psychomatrix.html');
                    }
                }
                
                if (!edgeResult.success) {
                    throw new Error(`Edge Function calculation failed: ${edgeResult.error || 'Unknown error'}`);
                }
                
                // 3. Query ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
                console.log(`üîç Querying Supabase for LifePath root_number = ${edgeResult.life_path_number}`);
                const lifePathQuery = await queryLifePathFromSupabase(edgeResult.life_path_number);
                
                console.log(`üîç Querying Supabase for Destiny id = ${edgeResult.destiny_number}`);
                const destinyQuery = await queryDestinyFromSupabase(edgeResult.destiny_number);
                
                // 4. Render ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                const mainContent = renderMainResult(edgeResult, lifePathQuery, destinyQuery);
                document.getElementById('result-content').innerHTML = mainContent;
                
                // 5. Render SQL Results
                const sqlContent = renderSQLResults(lifePathQuery, destinyQuery);
                document.getElementById('sql-content').innerHTML = `<pre class="tw-text-sm">${sqlContent}</pre>`;
                
                // 6. ‡∏ã‡πà‡∏≠‡∏ô loading message ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                document.getElementById('loading-message').classList.add('tw-hidden');
                document.getElementById('result-content').classList.remove('tw-hidden');
                
                console.log('=== PAGE INITIALIZATION COMPLETE ===');
                
                // 7. ‡πÇ‡∏´‡∏•‡∏î Life Path content ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (optional)
                // await loadLifePathContent(edgeResult.life_path_number);
                
            } catch (error) {
                console.error(`Initialization failed: ${error.message}`);
                
                document.getElementById('loading-message').innerHTML = `
                    <div class="tw-text-red-500 tw-text-center">
                        <p class="tw-text-xl tw-font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
                        <p class="tw-mt-2">${error.message}</p>
                        <a href="Psychomatrix.html" class="tw-inline-block tw-mt-4 tw-bg-blue-500 hover:tw-bg-blue-600 tw-text-white tw-font-bold tw-py-2 tw-px-4 tw-rounded">
                            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°
                        </a>
                    </div>
                `;
            }
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded - Starting initialization');
            initializePage();
        });

        // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏õ‡πá‡∏ô global
        window.loadLifePathContent = loadLifePathContent;
        window.loadDestinyContent = loadDestinyContent;
        window.switchTab = switchTab;
    </script>
</body>
</html>

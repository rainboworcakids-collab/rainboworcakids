<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychomatrix Analysis - RainbowOrcaKids</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/PsychomatrixStyle.css">
    
    <!-- Favicon -->
    <link rel="icon" href="images/PsychomatixAnalize.png" type="image/png">
    
    <!-- Scripts ตามลำดับ -->
    <script src="js/supabase-config.js"></script>
    <script src="js/debug-logger.js"></script>
    <script src="js/auth_status_manager.js"></script>
    <script src="js/nav.js"></script>
</head>
<body class="tw-bg-gray-100 tw-p-4">
    <!-- Navigation Bar -->
    <div id="nav-container"></div>

    <div class="tw-max-w-4xl tw-mx-auto tw-mt-6">
        <!-- Tabs -->
        <div class="tw-flex tw-border-b tw-border-gray-300">
            <button class="tablink active" onclick="switchTab('Main', this)">Main</button>
            <button class="tablink" onclick="switchTab('Explained', this)">Explained</button>
        </div>

        <!-- Main Tab -->
        <div id="Main" class="tabcontent active tw-bg-white tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <h1 class="tw-text-3xl tw-font-bold tw-text-center tw-mb-6">
                <img src="https://rainboworcakids-collab.github.io/rainboworcakids/images/PsychomatixAnalize.png" 
                     alt="Logo" class="tw-h-16 tw-w-16 tw-inline tw-mr-3">
                Psychomatrix Analysis
            </h1>
            <div id="loading-message" class="tw-text-center tw-py-8 tw-text-gray-500">
                กำลังโหลดข้อมูลจากระบบ...
            </div>
            <div id="result-content" style="display: none;">
                <!-- เนื้อหาจะถูก render ที่นี่ -->
            </div>
        </div>

        <!-- Explained Tab -->
        <div id="Explained" class="tabcontent tw-bg-white tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <div id="explained-content">
                <p class="tw-text-gray-500 tw-text-center">เลือกลิงก์จากตารางเพื่อดูรายละเอียดเพิ่มเติม</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== UTILITY FUNCTIONS ====================
        function switchTab(tabName, el) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tablink').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            el.classList.add('active');
        }

        // ดึงข้อมูลจาก URL Parameters
        function getDataFromURL() {
            const params = new URLSearchParams(window.location.search);
            
            return {
                success: true,
                birth_date: params.get('bd') || "13:05 22/05/1968", // format: 13:05 22/05/1968
                birth_day: params.get('day') || "22",
                birth_month: params.get('month') || "05",
                birth_year: params.get('year') || "1968",
                destiny_number: parseInt(params.get('destiny')) || 42,
                life_path_number: parseInt(params.get('lifepath')) || 6,
                life_path_meaning: params.get('meaning') || "กำลังโหลดความหมาย...",
                id_card: params.get('idc') || "",
                full_name: params.get('name') || "",
                option: params.get('opt') || "BD"
            };
        }

        // ดึงข้อมูลเพิ่มเติมจาก Supabase
        async function fetchLifePathMeaning(number) {
            try {
                DebugLogger.log(`Fetching LifePath ${number} from Supabase`);
                
                const response = await fetch(
                    `${window.SUPABASE_URL}/rest/v1/numerology_search_index?` + 
                    `element_type=eq.LifePath&root_number=eq.${number}`, 
                    {
                        headers: {
                            'apikey': window.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`
                        }
                    }
                );
                
                const data = await response.json();
                if (data && data[0] && data[0].summary) {
                    DebugLogger.log(`Found meaning: ${data[0].summary.substring(0, 50)}...`);
                    return data[0].summary;
                }
                return "ยังไม่มีความหมายในระบบ";
            } catch (error) {
                DebugLogger.error(`Fetch failed: ${error.message}`);
                return "เกิดข้อผิดพลาดในการโหลดความหมาย";
            }
        }

        // โหลดเนื้อหาจาก GitHub Pages
        async function fetchGitHubContent(path) {
            try {
                const url = `https://rainboworcakids-collab.github.io/rainboworcakids${path}`;
                DebugLogger.log(`Loading: ${url}`);
                
                const response = await fetch(url);
                return await response.text();
            } catch (error) {
                DebugLogger.error(`GitHub fetch failed: ${error.message}`);
                return `<p class="tw-text-red-500">ไม่สามารถโหลดเนื้อหาได้: ${error.message}</p>`;
            }
        }

        // ==================== RENDERING ====================
        function renderNumerologyTable(data) {
            const destinyLink = `/PsychomatrixContents/Destiny${data.destiny_number}.html`;
            const lifePathLink = `/PsychomatrixContents/LifePathNumber${data.life_path_number}.html`;

            return `
                <div class="tw-overflow-x-auto tw-my-6">
                    <table class="tw-w-full tw-border-collapse tw-border tw-border-gray-300">
                        <thead>
                            <tr class="tw-bg-gray-100">
                                <th class="tw-border tw-border-gray-300 tw-p-3">วันเกิด</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3">เดือนเกิด</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3">ปีเกิด</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3">โชคชะตา</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3">เส้นทางชีวิต</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_day || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_month || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_year || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3 tw-bg-blue-50 hover:tw-bg-blue-100 tw-cursor-pointer">
                                    <a href="#" class="tw-font-bold tw-text-blue-600 numerology-link hover:tw-text-blue-800" 
                                       data-href="${destinyLink}" data-tab="Explained">
                                        ${data.destiny_number}
                                    </a>
                                </td>
                                <td class="tw-border tw-border-gray-300 tw-p-3 tw-bg-green-50 hover:tw-bg-green-100 tw-cursor-pointer">
                                    <a href="#" class="tw-font-bold tw-text-green-600 numerology-link hover:tw-text-green-800" 
                                       data-href="${lifePathLink}" data-tab="Explained">
                                        ${data.life_path_number}
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPythagoreanSquare(counts) {
            return `
                <div class="tw-grid tw-grid-cols-4 tw-gap-2 tw-max-w-sm tw-mx-auto tw-my-6">
                    ${[1,2,3,4,5,6,7,8,9].map(num => 
                        `<div class="tw-border-2 tw-border-gray-400 tw-p-4 tw-text-center tw-font-bold">${counts[num] || 0}</div>`
                    ).join('')}
                    <div class="tw-col-span-4 tw-text-center tw-text-xs tw-text-gray-500 tw-mt-2">
                        พลังงานตัวเลข 1-9 (เซลล์ที่ 1-9)
                    </div>
                </div>
            `;
        }

        function renderResult(data) {
            return `
                <div class="tw-mb-6">
                    <h2 class="tw-text-2xl tw-font-bold tw-mb-4 tw-text-center">
                        วันเวลาเกิด: ${data.birth_date}
                    </h2>
                    
                    <div class="tw-grid md:tw-grid-cols-2 tw-gap-6 tw-mb-6">
                        <div class="tw-bg-blue-50 tw-border-l-4 tw-border-blue-500 tw-p-4 tw-rounded">
                            <h3 class="tw-text-lg tw-font-semibold tw-text-blue-800">เลขภาระกิจ</h3>
                            <p class="tw-text-3xl tw-font-bold tw-text-blue-600">
                                ${data.destiny_number} → ${data.destiny_number % 9 || 9}
                            </p>
                        </div>
                        <div class="tw-bg-green-50 tw-border-l-4 tw-border-green-500 tw-p-4 tw-rounded">
                            <h3 class="tw-text-lg tw-font-semibold tw-text-green-800">เลขเส้นทางชีวิต</h3>
                            <p class="tw-text-3xl tw-font-bold tw-text-green-600">
                                ${data.life_path_number}
                            </p>
                        </div>
                    </div>

                    <div class="tw-bg-gray-50 tw-p-4 tw-rounded tw-border tw-border-gray-200 tw-mb-6">
                        <h3 class="tw-font-semibold tw-mb-2">ความหมายเส้นทางชีวิต:</h3>
                        <p class="tw-text-gray-700">${data.life_path_meaning}</p>
                    </div>

                    ${renderNumerologyTable(data)}

                    <div class="tw-mt-8">
                        <h3 class="tw-text-xl tw-font-semibold tw-mb-4">Pythagorean Square</h3>
                        <div id="pythagorean-container" class="tw-text-center tw-py-4">
                            กำลังคำนวณพลังงานตัวเลข...
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== MAIN EXECUTION ====================
        async function initializePage() {
            try {
                DebugLogger.log('=== Initializing Result Page ===');
                
                // ดึงข้อมูลจาก URL
                const data = getDataFromURL();
                DebugLogger.log(`URL Data: ${JSON.stringify(data)}`);

                // ดึงความหมาย Life Path จาก Supabase
                const meaning = await fetchLifePathMeaning(data.life_path_number);
                data.life_path_meaning = meaning;

                // Render เนื้อหา
                document.getElementById('result-content').innerHTML = renderResult(data);
                document.getElementById('loading-message').style.display = 'none';
                document.getElementById('result-content').style.display = 'block';

                // คำนวณ Pythagorean Square
                const birthNumbers = data.birth_date.replace(/[:\/ ]/g, '');
                const counts = {};
                for(let i=1; i<=9; i++) counts[i] = 0;
                birthNumbers.split('').forEach(d => {
                    const num = parseInt(d);
                    if(num > 0) counts[num]++;
                });
                document.getElementById('pythagorean-container').innerHTML = renderPythagoreanSquare(counts);

                DebugLogger.log('=== Page Load Complete ===');
            } catch (error) {
                DebugLogger.error(`Fatal error: ${error.message}`);
                document.getElementById('loading-message').innerHTML = 
                    `<div class="tw-text-red-500 tw-text-center">
                        <p>เกิดข้อผิดพลาด: ${error.message}</p>
                    </div>`;
            }
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', initializePage);

        // จัดการลิงก์ใน Numerology Table
        document.addEventListener('click', async (e) => {
            const link = e.target.closest('.numerology-link');
            if (link) {
                e.preventDefault();
                const href = link.dataset.href;
                const content = await fetchGitHubContent(href);
                document.getElementById('explained-content').innerHTML = content;
                document.querySelector('[onclick*="Explained"]').click();
            }
        });
    </script>
</body>
</html>

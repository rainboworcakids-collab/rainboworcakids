<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychomatrix Analysis - RainbowOrcaKids</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/PsychomatrixStyle.css">
    
    <!-- Favicon -->
    <link rel="icon" href="images/PsychomatixAnalize.png" type="image/png">
    
    <!-- Scripts ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö -->
    <script src="js/supabase-config.js"></script>
    <script src="js/debug-logger.js"></script>
    <script src="js/auth_status_manager.js"></script>
    <script src="js/nav.js"></script>
    
    <!-- VERSION INDICATOR -->
    <script>
        const RESULT_PAGE_VERSION = "2.0.1-DEBUG-LOGGING";
    </script>
</head>
<body class="tw-bg-gray-100 tw-p-4">
    <!-- Navigation Bar -->
    <div id="nav-container"></div>

    <!-- VERSION DISPLAY -->
    <div class="tw-fixed tw-bottom-4 tw-right-4 tw-bg-gray-800 tw-text-white tw-px-3 tw-py-1 tw-rounded tw-text-xs tw-opacity-75">
        Ver: <span id="version-display">2.0.1</span>
    </div>

    <div class="tw-max-w-4xl tw-mx-auto tw-mt-6">
        <!-- Tabs -->
        <div class="tw-flex tw-border-b tw-border-gray-300">
            <button class="tablink active" onclick="switchTab('Main', this)">Main</button>
            <button class="tablink" onclick="switchTab('Explained', this)">Explained</button>
        </div>

        <!-- Main Tab -->
        <div id="Main" class="tabcontent active tw-bg-white tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <h1 class="tw-text-3xl tw-font-bold tw-text-center tw-mb-6">
                <img src="https://rainboworcakids-collab.github.io/rainboworcakids/images/PsychomatixAnalize.png" 
                     alt="Logo" class="tw-h-16 tw-w-16 tw-inline tw-mr-3">
                Psychomatrix Analysis
            </h1>
            
            <!-- DEBUG INFO DASHBOARD -->
            <div id="debug-dashboard" class="tw-bg-yellow-50 tw-border tw-border-yellow-300 tw-p-4 tw-rounded tw-mb-6" style="display: block;">
                <div class="tw-font-bold tw-mb-3 tw-text-yellow-800 tw-flex tw-items-center">
                    <i class="fas fa-bug tw-mr-2"></i>üîç DEBUG LOGGING DASHBOARD
                </div>
                <div id="debug-content" class="tw-font-mono tw-text-xs tw-space-y-1 tw-max-h-40 tw-overflow-y-auto"></div>
            </div>
            
            <!-- LOADING STATE -->
            <div id="loading-state" class="tw-text-center tw-py-8">
                <div class="tw-animate-pulse tw-text-gray-500">
                    <i class="fas fa-spinner tw-spin tw-mr-2"></i>
                    <span id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...</span>
                </div>
                <div id="loading-details" class="tw-text-xs tw-text-gray-400 tw-mt-2"></div>
            </div>

            <!-- RESULT CONTENT -->
            <div id="result-content" style="display: none;">
                <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å render ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
        </div>

        <!-- Explained Tab -->
        <div id="Explained" class="tabcontent tw-bg-white tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <div id="explained-content">
                <p class="tw-text-gray-500 tw-text-center tw-py-8">
                    <i class="fas fa-hand-pointer tw-mr-2"></i>
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== VERSION & DEBUG LOGGING ====================
        const RESULT_PAGE_VERSION = "2.0.1-DEBUG-LOGGING";
        
        // Centralized debug logging
        const debugLog = (message, type = 'info') => {
            const timestamp = new Date().toLocaleTimeString('th-TH');
            const debugContent = document.getElementById('debug-content');
            const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600';
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üîç';
            
            debugContent.innerHTML += `<div class="${color}">${icon} [${timestamp}] ${message}</div>`;
            DebugLogger.log(`[${type.toUpperCase()}] ${message}`);
            
            // Scroll to bottom
            debugContent.scrollTop = debugContent.scrollHeight;
        };

        const updateLoadingText = (text) => {
            document.getElementById('loading-text').textContent = text;
        };

        const updateLoadingDetails = (details) => {
            document.getElementById('loading-details').textContent = details;
        };

        // ==================== TAB SYSTEM ====================
        function switchTab(tabName, el) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tablink').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            el.classList.add('active');
        }

        // ==================== DATA FETCHING ====================
        // 1. Get data from URL
        function getDataFromURL() {
            debugLog('üîÑ Fetching URL parameters...', 'info');
            
            const params = new URLSearchParams(window.location.search);
            const data = {
                success: true,
                birth_date: params.get('bd') || "",
                birth_numbers: params.get('bn') || "",
                birth_day: params.get('day') || "",
                birth_month: params.get('month') || "",
                birth_year: params.get('year') || "",
                destiny_number: parseInt(params.get('destiny') || "0"),
                life_path_number: parseInt(params.get('lifepath') || "0"),
                id_card: params.get('idc') || "",
                full_name: params.get('name') || "",
                option: params.get('opt') || "BD"
            };
            
            debugLog(`üì• URL Data: ${JSON.stringify(data)}`, 'success');
            
            // Validate
            if (!data.birth_date) debugLog('‚ö†Ô∏è Warning: birth_date not found in URL', 'error');
            if (!data.destiny_number) debugLog('‚ö†Ô∏è Warning: destiny_number not found in URL', 'error');
            if (!data.life_path_number) debugLog('‚ö†Ô∏è Warning: life_path_number not found in URL', 'error');
            
            return data;
        }

        // 2. Query Supabase - SQL: SELECT * FROM numerology_search_index WHERE element_type='LifePath' AND root_number=?
        async function fetchLifePathFromSupabase(rootNumber) {
            debugLog(`üóÑÔ∏è Preparing Supabase query for LifePath ${rootNumber}...`, 'info');
            
            if (!rootNumber || rootNumber < 1 || rootNumber > 9) {
                debugLog(`‚ùå Invalid LifePath number: ${rootNumber}`, 'error');
                return { 
                    success: false, 
                    error: "Invalid LifePath number",
                    summary: "‡πÄ‡∏•‡∏Ç‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
                    html_path: ""
                };
            }

            try {
                // Construct query URL
                const query = `element_type=eq.LifePath&root_number=eq.${rootNumber}&select=*`;
                const url = `${window.SUPABASE_URL}/rest/v1/numerology_search_index?${query}`;
                
                debugLog(`üîó SQL URL: ${url}`, 'info');
                debugLog(`üìù SQL Query: SELECT * FROM numerology_search_index WHERE element_type='LifePath' AND root_number=${rootNumber}`, 'info');
                updateLoadingText(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LifePath ${rootNumber} ‡∏à‡∏≤‡∏Å Supabase...`);
                
                const response = await fetch(url, {
                    headers: {
                        'apikey': window.SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`
                    }
                });
                
                debugLog(`üì° HTTP Response Status: ${response.status} ${response.statusText}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                debugLog(`üì¶ Raw Supabase Response: ${JSON.stringify(data)}`, 'success');
                
                if (data && data.length > 0 && data[0]) {
                    const row = data[0];
                    debugLog(`‚úÖ Found LifePath record: ID=${row.id}, Title=${row.title}`, 'success');
                    debugLog(`üìù Summary: ${row.summary ? row.summary.substring(0, 100) + '...' : 'No summary'}`, 'success');
                    
                    return {
                        success: true,
                        id: row.id,
                        element_type: row.element_type,
                        root_number: row.root_number,
                        title: row.title,
                        summary: row.summary || "‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö",
                        html_content: row.html_content,
                        html_path: row.html_path || `/PsychomatrixContents/LifePathNumber${rootNumber}.html`
                    };
                }
                
                debugLog(`‚ö†Ô∏è No records found for LifePath ${rootNumber}`, 'warning');
                debugLog(`üîÑ Will use GitHub fallback`, 'info');
                
                return {
                    success: false,
                    error: "No data found",
                    summary: "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Supabase ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å GitHub...",
                    html_path: `/PsychomatrixContents/LifePathNumber${rootNumber}.html`
                };
            } catch (error) {
                debugLog(`‚ùå Supabase Error: ${error.message}`, 'error');
                debugLog(`üîÑ Falling back to GitHub`, 'info');
                
                return {
                    success: false,
                    error: error.message,
                    summary: `‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å GitHub...`,
                    html_path: `/PsychomatrixContents/LifePathNumber${rootNumber}.html`
                };
            }
        }

        // 3. Load from GitHub (Fallback)
        async function fetchGitHubContent(path) {
            debugLog(`üåê Loading from GitHub: ${path}`, 'info');
            updateLoadingText(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å GitHub...`);
            
            try {
                const url = `https://rainboworcakids-collab.github.io/rainboworcakids${path}`;
                debugLog(`üåê Full URL: ${url}`, 'info');
                
                const response = await fetch(url);
                debugLog(`üì° GitHub HTTP Status: ${response.status}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`GitHub HTTP ${response.status} - ${response.statusText}`);
                }
                
                const content = await response.text();
                debugLog(`‚úÖ GitHub content loaded: ${content.length} characters`, 'success');
                
                return content;
            } catch (error) {
                debugLog(`‚ùå GitHub Error: ${error.message}`, 'error');
                return `<div class="tw-text-red-500 tw-p-4 tw-bg-red-50 tw-rounded tw-border tw-border-red-200">
                    <p class="tw-font-bold"><i class="fas fa-exclamation-circle tw-mr-2"></i>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏î‡πâ</p>
                    <p class="tw-text-sm tw-mt-1">${error.message}</p>
                </div>`;
            }
        }

        // ==================== RENDERING ====================
        function renderNumerologyTable(data) {
            if (!data.destiny_number || !data.life_path_number) {
                debugLog('‚ùå Cannot render table: missing destiny or life_path number', 'error');
                return '<div class="tw-text-red-500 tw-text-center tw-p-4">‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏î‡πâ</div>';
            }

            const destinyLink = `/PsychomatrixContents/Destiny${data.destiny_number}.html`;
            const lifePathLink = `/PsychomatrixContents/LifePathNumber${data.life_path_number}.html`;

            debugLog(`üìä Rendering Numerology Table: Destiny=${data.destiny_number}, LifePath=${data.life_path_number}`, 'info');

            return `
                <div class="tw-overflow-x-auto tw-my-6">
                    <table class="tw-w-full tw-border-collapse tw-border tw-border-gray-300 tw-shadow-sm">
                        <thead>
                            <tr class="tw-bg-gradient-to-r tw-from-blue-50 tw-to-green-50">
                                <th class="tw-border tw-border-gray-300 tw-p-3 tw-font-semibold">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3 tw-font-semibold">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3 tw-font-semibold">‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3 tw-font-semibold">‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3 tw-font-semibold">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="hover:tw-bg-gray-50">
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_day || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_month || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_year || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3 tw-bg-blue-50 hover:tw-bg-blue-100 tw-cursor-pointer">
                                    <a href="#" class="tw-font-bold tw-text-blue-600 numerology-link hover:tw-text-blue-800" 
                                       data-href="${destinyLink}" data-tab="Explained">
                                        ${data.destiny_number}
                                    </a>
                                </td>
                                <td class="tw-border tw-border-gray-300 tw-p-3 tw-bg-green-50 hover:tw-bg-green-100 tw-cursor-pointer">
                                    <a href="#" class="tw-font-bold tw-text-green-600 numerology-link hover:tw-text-green-800" 
                                       data-href="${lifePathLink}" data-tab="Explained">
                                        ${data.life_path_number}
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPythagoreanSquare(counts) {
            if (!counts || Object.keys(counts).length === 0) {
                debugLog('‚ö†Ô∏è No counts data for Pythagorean Square', 'warning');
                return '<div class="tw-text-gray-500 tw-text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</div>';
            }

            debugLog(`üìê Rendering Pythagorean Square: ${JSON.stringify(counts)}`, 'info');

            return `
                <div class="tw-grid tw-grid-cols-4 tw-gap-3 tw-max-w-xs tw-mx-auto tw-my-6">
                    ${[1,2,3,4,5,6,7,8,9].map(num => 
                        `<div class="tw-border-2 tw-border-gray-400 tw-p-5 tw-text-center tw-font-bold tw-bg-white hover:tw-bg-gray-50 tw-transition-all">
                            <div class="tw-text-2xl">${counts[num] || 0}</div>
                            <div class="tw-text-xs tw-text-gray-500">${num}</div>
                        </div>`
                    ).join('')}
                    <div class="tw-col-span-4 tw-text-center tw-text-xs tw-text-gray-500 tw-mt-2 tw-font-semibold">
                        ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1-9 (‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà 1-9)
                    </div>
                </div>
            `;
        }

        function renderResult(data, lifePathData) {
            debugLog(`üé® Rendering Result Page...`, 'info');

            return `
                <div class="tw-mb-6">
                    <h2 class="tw-text-2xl tw-font-bold tw-mb-4 tw-text-center tw-text-gray-800">
                        üìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î: ${data.birth_date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                    </h2>
                    
                    <!-- Summary Cards -->
                    <div class="tw-grid md:tw-grid-cols-2 tw-gap-6 tw-mb-8">
                        <div class="tw-bg-blue-50 tw-border-l-4 tw-border-blue-500 tw-p-6 tw-rounded-lg tw-shadow-sm">
                            <h3 class="tw-text-lg tw-font-semibold tw-text-blue-800 tw-mb-2">‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏£‡∏∞‡∏Å‡∏¥‡∏à (Destiny)</h3>
                            <p class="tw-text-4xl tw-font-bold tw-text-blue-600 tw-mb-1">${data.destiny_number || '?'}</p>
                        </div>
                        <div class="tw-bg-green-50 tw-border-l-4 tw-border-green-500 tw-p-6 tw-rounded-lg tw-shadow-sm">
                            <h3 class="tw-text-lg tw-font-semibold tw-text-green-800 tw-mb-2">‡πÄ‡∏•‡∏Ç‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (Life Path)</h3>
                            <p class="tw-text-4xl tw-font-bold tw-text-green-600 tw-mb-1">${data.life_path_number || '?'}</p>
                        </div>
                    </div>

                    <!-- Life Path Meaning -->
                    <div class="tw-bg-gradient-to-r tw-from-purple-50 tw-to-pink-50 tw-p-6 tw-rounded-lg tw-border-l-4 tw-border-purple-500 tw-mb-8">
                        <h3 class="tw-font-semibold tw-mb-3 tw-text-gray-800 tw-flex tw-items-center">
                            <i class="fas fa-book-open tw-mr-2 tw-text-purple-600"></i>
                            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (‡∏à‡∏≤‡∏Å Supabase):
                        </h3>
                        <p class="tw-text-gray-700 tw-leading-relaxed tw-whitespace-pre-line">${lifePathData.summary || lifePathData}</p>
                        ${lifePathData.success ? 
                            `<div class="tw-text-xs tw-text-green-600 tw-mt-2"><i class="fas fa-check-circle tw-mr-1"></i>‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>` :
                            `<div class="tw-text-xs tw-text-yellow-600 tw-mt-2"><i class="fas fa-exclamation-triangle tw-mr-1"></i>‡πÉ‡∏ä‡πâ Fallback (GitHub)</div>`
                        }
                    </div>

                    ${renderNumerologyTable(data)}

                    <div class="tw-mt-10">
                        <h3 class="tw-text-2xl tw-font-semibold tw-mb-6 tw-text-center tw-text-gray-800">
                            <i class="fas fa-th tw-mr-2 tw-text-blue-600"></i>
                            Pythagorean Square
                        </h3>
                        <div id="pythagorean-container" class="tw-text-center tw-py-6">
                            <div class="tw-animate-pulse tw-text-gray-500">
                                <i class="fas fa-spinner tw-spin tw-mr-2"></i>
                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç...
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== MAIN EXECUTION ====================
        async function initializePage() {
            try {
                debugLog('=====================================', 'info');
                debugLog(`üöÄ PAGE INITIALIZATION START`, 'info');
                debugLog(`üì¶ Version: ${RESULT_PAGE_VERSION}`, 'info');
                debugLog(`üåê URL: ${window.location.href}`, 'info');
                debugLog(`üîç URL Search Params: ${window.location.search}`, 'info');
                
                // ‡πÅ‡∏™‡∏î‡∏á version
                document.getElementById('version-display').textContent = RESULT_PAGE_VERSION;
                
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL
                updateLoadingText('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL...');
                const data = getDataFromURL();
                debugLog(`‚úÖ Data extracted from URL`, 'success');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                if (!data.birth_date || !data.destiny_number || !data.life_path_number) {
                    throw new Error(`Missing required data: birth_date=${data.birth_date}, destiny=${data.destiny_number}, lifepath=${data.life_path_number}`);
                }
                
                debugLog(`‚úÖ Data validation passed`, 'success');

                // ‡∏î‡∏∂‡∏á LifePath ‡∏à‡∏≤‡∏Å Supabase
                updateLoadingText(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î LifePath ‡∏à‡∏≤‡∏Å Supabase...`);
                debugLog(`üóÑÔ∏è Starting Supabase query...`, 'info');
                
                const lifePathData = await fetchLifePathFromSupabase(data.life_path_number);
                
                if (lifePathData.success) {
                    debugLog(`‚úÖ Loaded LifePath from Supabase successfully`, 'success');
                } else {
                    debugLog(`‚ö†Ô∏è Using fallback for LifePath`, 'warning');
                }

                // Render ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                updateLoadingText('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                debugLog(`üé® Rendering result content...`, 'info');
                
                document.getElementById('result-content').innerHTML = renderResult(data, lifePathData);
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('result-content').style.display = 'block';
                
                debugLog(`‚úÖ Result content rendered`, 'success');

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Pythagorean Square
                updateLoadingText('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Pythagorean Square...');
                debugLog(`üî¢ Calculating Pythagorean Square...`, 'info');
                
                const birthNumbers = data.birth_date.replace(/[:\/ ]/g, '');
                debugLog(`üî¢ Birth numbers: ${birthNumbers}`, 'info');
                
                const counts = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
                birthNumbers.split('').forEach(d => {
                    const num = parseInt(d);
                    if(num >= 1 && num <= 9) counts[num]++;
                });
                
                debugLog(`üìä Pythagorean counts: ${JSON.stringify(counts)}`, 'success');
                document.getElementById('pythagorean-container').innerHTML = renderPythagoreanSquare(counts);
                
                debugLog(`‚úÖ Pythagorean Square rendered`, 'success');
                debugLog(`üéâ PAGE INITIALIZATION COMPLETE`, 'success');
                debugLog('=====================================', 'info');

            } catch (error) {
                debugLog(`‚ùå FATAL ERROR: ${error.message}`, 'error');
                DebugLogger.error(`Fatal error: ${error.message}`);
                
                document.getElementById('loading-state').innerHTML = 
                    `<div class="tw-text-red-500 tw-text-center tw-p-6 tw-bg-red-50 tw-rounded-lg tw-border tw-border-red-200">
                        <p class="tw-font-bold tw-text-xl tw-flex tw-items-center tw-justify-center">
                            <i class="fas fa-exclamation-triangle tw-mr-2"></i>
                            ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </p>
                        <p class="tw-text-sm tw-mt-3 tw-text-red-600">${error.message}</p>
                        <div class="tw-text-xs tw-mt-2 tw-bg-red-100 tw-p-2 tw-rounded tw-font-mono">
                            ${error.stack || ''}
                        </div>
                        <button onclick="history.back()" class="tw-bg-blue-500 tw-text-white tw-px-6 tw-py-3 tw-rounded-lg tw-mt-4 hover:tw-bg-blue-600">
                            <i class="fas fa-arrow-left tw-mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>`;
            }
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('üìù DOM Content Loaded - Starting initialization...', 'info');
            initializePage();
        });

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô Numerology Table
        document.addEventListener('click', async (e) => {
            const link = e.target.closest('.numerology-link');
            if (link) {
                e.preventDefault();
                const href = link.dataset.href;
                debugLog(`üñ±Ô∏è Link clicked: ${href}`, 'info');
                
                updateLoadingText(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å ${href}...`);
                document.getElementById('explained-content').innerHTML = '<div class="tw-text-center tw-py-8"><i class="fas fa-spinner tw-spin tw-mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
                
                const content = await fetchGitHubContent(href);
                document.getElementById('explained-content').innerHTML = content;
                
                updateLoadingText('‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
                document.querySelector('[onclick*="Explained"]').click();
            }
        });
    </script>
</body>
</html>

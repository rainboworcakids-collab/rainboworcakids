<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychomatrix Result - RainbowOrcaKids</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Pinnacle Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.0"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/PsychomatrixStyle.css">
    
    <style>
        /* Tab System */
        .tablink {
            background-color: #eee;
            color: #aaa;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            font-size: 17px;
            width: 50%;
            transition: all 0.3s ease;
        }
        .tablink:hover {
            background-color: green;
            color: yellow;
            transform: translateY(-2px);
        }
        .tablink.active {
            background-color: #1e40af;
            color: white;
        }
        .tabcontent {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Result Card */
        .result-card {
            background: linear-gradient(135deg, #f1f2ff 0%, #e9e9ff 100%);
            border-left: 4px solid #1e40af;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        
        /* Error Message */
        .error-message {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #b91c1c;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* Success Message */
        .success-message {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen tw-p-4">
    
    <!-- Loading Spinner -->
    <div id="loadingIndicator" class="loading-spinner">
        <div class="bg-white p-6 rounded-xl shadow-2xl">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-center font-medium text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</p>
        </div>
    </div>
    
    <!-- Header -->
    <div class="max-w-6xl mx-auto mb-6">
        <div class="text-center p-4 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-white mb-2">üîÆ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Psychomatrix</h1>
            <p id="resultTitle" class="text-blue-100">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>
    
    <!-- Tab Navigation -->
    <div class="max-w-6xl mx-auto mb-0">
        <div class="flex rounded-t-xl overflow-hidden shadow-lg">
            <button class="tablink active" onclick="switchTab('Main', this)" id="defaultOpen">
                üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏Å
            </button>
            <button class="tablink" onclick="switchTab('Explained', this)">
                üìñ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            </button>
        </div>
    </div>
    
    <!-- Tab Content -->
    <div class="max-w-6xl mx-auto mb-6">
        
        <!-- Main Tab -->
        <div id="Main" class="tabcontent bg-white p-6 rounded-b-xl shadow-lg" style="display: block;">
            <!-- Result Content -->
            <div id="mainResultContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            
            <!-- Error Message Container -->
            <div id="errorContainer" style="display: none;"></div>
            
            <!-- Back Button -->
            <div class="text-center mt-8">
                <button onclick="window.location.href='Psychomatrix.html'" 
                        class="bg-gradient-to-r from-blue-500 to-blue-700 hover:from-green-500 hover:to-green-700 
                               text-white px-8 py-3 rounded-full font-bold text-lg shadow-lg transition-all duration-200">
                    ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
        
        <!-- Explained Tab -->
        <div id="Explained" class="tabcontent bg-white p-6 rounded-b-xl shadow-lg">
            <div id="explainedContent">
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">üìñ</div>
                    <p class="text-xl">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="max-w-6xl mx-auto text-center py-4">
        <p class="text-gray-500 text-sm">¬© 2025 RainbowOrcaKids - Psychomatrix Analysis System</p>
    </div>
    
    <!-- Result JavaScript -->
    <script>
        // ==================== GLOBAL VARIABLES ====================
        let resultData = null;
        let pinnacleData = null;
        
        // ==================== INITIALIZE PAGE ====================
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Load result from sessionStorage
                const storedResult = sessionStorage.getItem('psychomatrixResult');
                if (!storedResult) {
                    throw new Error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà');
                }
                
                resultData = JSON.parse(storedResult);
                console.log('‚úÖ Loaded result data:', resultData);
                
                // Display results
                displayResults();
                
            } catch (error) {
                showError(error.message);
                console.error('Error loading result:', error);
            }
        });
        
        // ==================== DISPLAY FUNCTIONS ====================
        
        function displayResults() {
            const contentDiv = document.getElementById('mainResultContent');
            const titleEl = document.getElementById('resultTitle');
            
            if (!resultData || !resultData.results || resultData.results.length === 0) {
                showError('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                return;
            }
            
            // Set title
            titleEl.textContent = `‡∏ä‡∏∑‡πà‡∏≠: ${resultData.search_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} | ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${getOptionLabel(resultData.option)}`;
            
            let html = '';
            
            // Loop through each result section
            resultData.results.forEach((result, index) => {
                html += `
                    <div class="result-card">
                        <h2 class="text-2xl font-bold text-blue-700 mb-4 pb-2 border-b-2 border-blue-200">
                            ${result.title || '‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå'}
                        </h2>
                        <div class="space-y-4">
                `;
                
                // Display each data item
                if (result.data) {
                    Object.entries(result.data).forEach(([key, value]) => {
                        if (key === 'Numerology Table') {
                            // Display table as HTML
                            html += `<div class="mt-4">${value}</div>`;
                        } else if (key === 'Pythagorean Square') {
                            // Display Pythagorean Square
                            html += `
                                <div class="flex items-center justify-between mt-4">
                                    <h3 class="text-lg font-bold text-purple-700">${key}</h3>
                                    <div class="flex gap-2">
                                        <button onclick="loadPythagoreanDetail()" 
                                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm">
                                            üìä ‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-2">${value}</div>
                            `;
                        } else if (key.includes('‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•')) {
                            // Highlight influential numbers
                            html += `
                                <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mt-4">
                                    <h3 class="text-lg font-bold text-yellow-800 mb-2">${key}</h3>
                                    <p class="text-gray-700">${value}</p>
                                </div>
                            `;
                        } else {
                            // Normal key-value pair
                            html += `
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <h3 class="font-bold text-gray-800">${key}</h3>
                                    <p class="text-gray-700 mt-1">${value}</p>
                                </div>
                            `;
                        }
                    });
                }
                
                // Add navigation buttons if Pythagorean Square exists
                if (result.data && (result.data['Pythagorean Square'] || result.data['Numerology Table'])) {
                    html += `
                        <div class="flex justify-center gap-4 mt-6 pt-4 border-t border-gray-200">
                            ${result.data['Pythagorean Square'] ? `
                                <button onclick="loadPythagoreanDetail()" 
                                        class="bg-gradient-to-r from-blue-500 to-blue-700 hover:from-green-500 hover:to-green-700 
                                               text-white px-6 py-3 rounded-full font-medium shadow-lg transition-all duration-200 tw-w-40">
                                    üß© ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏¥‡∏ò‡∏≤‡∏Å‡∏≠‡∏£‡∏±‡∏™
                                </button>
                            ` : ''}
                            <button onclick="loadNumerologyContent('Destiny${result.destiny_number || ''}')" 
                                    class="bg-gradient-to-r from-purple-500 to-purple-700 hover:from-pink-500 hover:to-pink-700 
                                           text-white px-6 py-3 rounded-full font-medium shadow-lg transition-all duration-200 tw-w-40">
                                üìñ ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠
                            </button>
                        </div>
                    `;
                }
                
                html += `</div></div>`;
            });
            
            contentDiv.innerHTML = html;
        }
        
        function loadPythagoreanDetail() {
            // Load Pythagorean Square explanation
            document.getElementById('explainedContent').innerHTML = `
                <div class="result-card">
                    <h2 class="text-2xl font-bold text-purple-700 mb-4">üß© ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏¥‡∏ò‡∏≤‡∏Å‡∏≠‡∏£‡∏±‡∏™</h2>
                    <p class="text-gray-700 mb-4">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏¥‡∏ò‡∏≤‡∏Å‡∏≠‡∏£‡∏±‡∏™‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏∏‡∏ì</p>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-bold text-blue-800 mb-3">‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏•‡∏±‡∏á‡∏™‡∏π‡∏á</h3>
                            <p class="text-gray-700">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                        </div>
                        <div class="bg-pink-50 p-4 rounded-lg">
                            <h3 class="font-bold text-pink-800 mb-3">‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏û‡∏•‡∏±‡∏á</h3>
                            <p class="text-gray-700">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÄ‡∏•‡∏¢ ‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ñ‡∏∂‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</p>
                        </div>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="switchTab('Main', document.querySelector('.tablink'))" 
                                class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        </button>
                    </div>
                </div>
            `;
            switchTab('Explained', document.querySelectorAll('.tablink')[1]);
        }
        
        function loadNumerologyContent(contentPath) {
            const explainedDiv = document.getElementById('explainedContent');
            
            // Show loading
            explainedDiv.innerHTML = `
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-lg text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤...</p>
                </div>
            `;
            
            switchTab('Explained', document.querySelectorAll('.tablink')[1]);
            
            // Load from GitHub Pages static content
            fetch(`PsychomatrixContents/${contentPath}.html`)
                .then(response => {
                    if (!response.ok) throw new Error('Content not found');
                    return response.text();
                })
                .then(html => {
                    explainedDiv.innerHTML = `
                        <div class="result-card">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-purple-700">üìñ ${contentPath}</h2>
                                <button onclick="switchTab('Main', document.querySelector('.tablink'))" 
                                        class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                                    ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
                                </button>
                            </div>
                            <div class="prose max-w-none">${html}</div>
                        </div>
                    `;
                    // Execute any scripts in loaded content
                    executeScripts(explainedDiv);
                })
                .catch(error => {
                    explainedDiv.innerHTML = `
                        <div class="error-message">
                            <h3 class="font-bold text-lg mb-2">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</h3>
                            <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î ${contentPath} ‡πÑ‡∏î‡πâ: ${error.message}</p>
                            <p class="text-sm mt-2">‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå PsychomatrixContents/</p>
                        </div>
                    `;
                });
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        
        function switchTab(tabName, elmnt) {
            // Hide all tabcontent
            const tabcontent = document.getElementsByClassName('tabcontent');
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = 'none';
            }
            
            // Remove active class from all tablinks
            const tablinks = document.getElementsByClassName('tablink');
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove('active');
            }
            
            // Show current tab and add active class
            document.getElementById(tabName).style.display = 'block';
            elmnt.classList.add('active');
        }
        
        function getOptionLabel(optionValue) {
            const options = {
                'BD': 'Birth Date ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                'IDC': 'ID Card ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                'FullName': 'Full Name ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                'BD-IDC': 'Birth Date + ID Card',
                'BD-IDC-FullName': 'Birth + ID + Name',
                'Num-Ard': '‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß'
            };
            return options[optionValue] || optionValue;
        }
        
        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `
                <div class="error-message">
                    <h3 class="font-bold text-lg mb-2">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                    <p>${message}</p>
                    <div class="mt-4 text-center">
                        <button onclick="window.location.href='Psychomatrix.html'" 
                                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                </div>
            `;
            container.style.display = 'block';
        }
        
        function executeScripts(container) {
            const scripts = container.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                if (oldScript.src) {
                    newScript.src = oldScript.src;
                } else {
                    newScript.textContent = oldScript.textContent;
                }
                document.body.appendChild(newScript).parentNode.removeChild(newScript);
            });
        }
        
        // ==================== Pinnacle Graph (if exists) ====================
        
        function renderPinnacleGraph(data) {
            if (!data || !pinnacleData) return;
            
            const graphContainer = document.getElementById('pinnacleGraphContainer');
            if (!graphContainer) return;
            
            // This will be populated if pinnacle data exists
            // Implementation depends on Edge Function returning graph data
        }
    </script>
</body>
</html>

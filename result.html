<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychomatrix Analysis - RainbowOrcaKids</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/PsychomatrixStyle.css">
    
    <!-- Favicon -->
    <link rel="icon" href="images/PsychomatixAnalize.png" type="image/png">
    
    <!-- Scripts ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö -->
    <script src="js/supabase-config.js"></script>
    <script src="js/debug-logger.js"></script>
    <script src="js/auth_status_manager.js"></script>
    <script src="js/nav.js"></script>
</head>
<body class="tw-bg-gray-100 tw-p-4">
    <!-- Navigation Bar -->
    <div id="nav-container"></div>

    <div class="tw-max-w-4xl tw-mx-auto tw-mt-6">
        <!-- Tabs -->
        <div class="tw-flex tw-border-b tw-border-gray-300">
            <button class="tablink active" onclick="switchTab('Main', this)">Main</button>
            <button class="tablink" onclick="switchTab('Explained', this)">Explained</button>
        </div>

        <!-- Main Tab -->
        <div id="Main" class="tabcontent active tw-bg-white tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <h1 class="tw-text-3xl tw-font-bold tw-text-center tw-mb-6">
                <img src="https://rainboworcakids-collab.github.io/rainboworcakids/images/PsychomatixAnalize.png" 
                     alt="Logo" class="tw-h-16 tw-w-16 tw-inline tw-mr-3">
                Psychomatrix Analysis
            </h1>
            <div id="loading-message" class="tw-text-center tw-py-8 tw-text-gray-500">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...
            </div>
            <div id="result-content" style="display: none;">
                <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å render ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
        </div>

        <!-- Explained Tab -->
        <div id="Explained" class="tabcontent tw-bg-white tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <div id="explained-content">
                <p class="tw-text-gray-500 tw-text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== UTILITY FUNCTIONS ====================
        function switchTab(tabName, el) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tablink').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            el.classList.add('active');
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL Parameters
        function getDataFromURL() {
            const params = new URLSearchParams(window.location.search);
            
            return {
                success: true,
                birth_date: params.get('bd') || "", // 13:05 22/05/1968
                birth_day: params.get('day') || "",
                birth_month: params.get('month') || "",
                birth_year: params.get('year') || "",
                destiny_number: parseInt(params.get('destiny') || "0"),
                life_path_number: parseInt(params.get('lifepath') || "0"),
                id_card: params.get('idc') || "",
                full_name: params.get('name') || "",
                option: params.get('opt') || "BD"
            };
        }

        // ‡∏î‡∏∂‡∏á LifePath ‡∏à‡∏≤‡∏Å Supabase
        async function fetchLifePathMeaning(rootNumber) {
            if (!rootNumber || rootNumber < 1 || rootNumber > 9) {
                return { summary: "‡πÄ‡∏•‡∏Ç‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" };
            }

            try {
                DebugLogger.log(`üîç Querying LifePath ${rootNumber} from Supabase`);
                
                const response = await fetch(
                    `${window.SUPABASE_URL}/rest/v1/numerology_search_index?` + 
                    `element_type=eq.LifePath&root_number=eq.${rootNumber}`, 
                    {
                        headers: {
                            'apikey': window.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`
                        }
                    }
                );
                
                const data = await response.json();
                
                if (data && data[0]) {
                    DebugLogger.log(`‚úÖ Found LifePath data: ${data[0].title}`);
                    return {
                        summary: data[0].summary || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢",
                        html_path: data[0].html_path || `/PsychomatrixContents/LifePathNumber${rootNumber}.html`
                    };
                }
                
                return {
                    summary: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö",
                    html_path: `/PsychomatrixContents/LifePathNumber${rootNumber}.html`
                };
            } catch (error) {
                DebugLogger.error(`‚ùå Supabase fetch failed: ${error.message}`);
                return {
                    summary: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢",
                    html_path: `/PsychomatrixContents/LifePathNumber${rootNumber}.html`
                };
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å GitHub Pages
        async function fetchGitHubContent(path) {
            try {
                const url = `https://rainboworcakids-collab.github.io/rainboworcakids${path}`;
                DebugLogger.log(`üì• Loading from GitHub: ${url}`);
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                return await response.text();
            } catch (error) {
                DebugLogger.error(`‚ùå GitHub fetch failed: ${error.message}`);
                return `<p class="tw-text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏î‡πâ: ${error.message}</p>`;
            }
        }

        // ==================== RENDERING ====================
        function renderNumerologyTable(data) {
            if (!data.destiny_number || !data.life_path_number) {
                return '<div class="tw-text-red-500 tw-text-center tw-p-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏î‡πâ</div>';
            }

            const destinyLink = `/PsychomatrixContents/Destiny${data.destiny_number}.html`;
            const lifePathLink = `/PsychomatrixContents/LifePathNumber${data.life_path_number}.html`;

            return `
                <div class="tw-overflow-x-auto tw-my-6">
                    <table class="tw-w-full tw-border-collapse tw-border tw-border-gray-300 tw-shadow-sm">
                        <thead>
                            <tr class="tw-bg-gradient-to-r tw-from-blue-50 tw-to-green-50">
                                <th class="tw-border tw-border-gray-300 tw-p-3 tw-font-semibold">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3 tw-font-semibold">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3 tw-font-semibold">‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3 tw-font-semibold">‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3 tw-font-semibold">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="hover:tw-bg-gray-50 tw-transition-colors">
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_day || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_month || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_year || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3 tw-bg-blue-50 hover:tw-bg-blue-100 tw-cursor-pointer">
                                    <a href="#" class="tw-font-bold tw-text-blue-600 numerology-link hover:tw-text-blue-800 tw-underline" 
                                       data-href="${destinyLink}" data-tab="Explained">
                                        ${data.destiny_number}
                                    </a>
                                </td>
                                <td class="tw-border tw-border-gray-300 tw-p-3 tw-bg-green-50 hover:tw-bg-green-100 tw-cursor-pointer">
                                    <a href="#" class="tw-font-bold tw-text-green-600 numerology-link hover:tw-text-green-800 tw-underline" 
                                       data-href="${lifePathLink}" data-tab="Explained">
                                        ${data.life_path_number}
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPythagoreanSquare(counts) {
            if (!counts || Object.keys(counts).length === 0) {
                return '<div class="tw-text-gray-500 tw-text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</div>';
            }

            return `
                <div class="tw-grid tw-grid-cols-4 tw-gap-3 tw-max-w-xs tw-mx-auto tw-my-6">
                    ${[1,2,3,4,5,6,7,8,9].map(num => 
                        `<div class="tw-border-2 tw-border-gray-400 tw-p-5 tw-text-center tw-font-bold tw-bg-white hover:tw-bg-gray-50 tw-transition-all">
                            <div class="tw-text-2xl">${counts[num] || 0}</div>
                            <div class="tw-text-xs tw-text-gray-500">${num}</div>
                        </div>`
                    ).join('')}
                    <div class="tw-col-span-4 tw-text-center tw-text-xs tw-text-gray-500 tw-mt-2 tw-font-semibold">
                        ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1-9 (‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà 1-9)
                    </div>
                </div>
            `;
        }

        function renderResult(data, lifePathData) {
            return `
                <div class="tw-mb-6">
                    <h2 class="tw-text-2xl tw-font-bold tw-mb-4 tw-text-center tw-text-gray-800">
                        üìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î: ${data.birth_date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                    </h2>
                    
                    <!-- Summary Cards -->
                    <div class="tw-grid md:tw-grid-cols-2 tw-gap-6 tw-mb-8">
                        <div class="tw-bg-blue-50 tw-border-l-4 tw-border-blue-500 tw-p-6 tw-rounded-lg tw-shadow-sm hover:tw-shadow-md tw-transition-shadow">
                            <h3 class="tw-text-lg tw-font-semibold tw-text-blue-800 tw-mb-2">‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏£‡∏∞‡∏Å‡∏¥‡∏à (Destiny)</h3>
                            <p class="tw-text-4xl tw-font-bold tw-text-blue-600 tw-mb-1">
                                ${data.destiny_number || '?'}
                            </p>
                            <p class="tw-text-sm tw-text-blue-500">
                                ${data.destiny_number ? `${data.destiny_number} ‚Üí ${data.destiny_number % 9 || 9}` : 'N/A'}
                            </p>
                        </div>
                        <div class="tw-bg-green-50 tw-border-l-4 tw-border-green-500 tw-p-6 tw-rounded-lg tw-shadow-sm hover:tw-shadow-md tw-transition-shadow">
                            <h3 class="tw-text-lg tw-font-semibold tw-text-green-800 tw-mb-2">‡πÄ‡∏•‡∏Ç‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (Life Path)</h3>
                            <p class="tw-text-4xl tw-font-bold tw-text-green-600 tw-mb-1">
                                ${data.life_path_number || '?'}
                            </p>
                            <p class="tw-text-sm tw-text-green-500">
                                Life Path Number
                            </p>
                        </div>
                    </div>

                    <!-- Life Path Meaning -->
                    <div class="tw-bg-gradient-to-r tw-from-purple-50 tw-to-pink-50 tw-p-6 tw-rounded-lg tw-border-l-4 tw-border-purple-500 tw-mb-8">
                        <h3 class="tw-font-semibold tw-mb-3 tw-text-gray-800">
                            <i class="fas fa-book-open tw-mr-2"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï:
                        </h3>
                        <p class="tw-text-gray-700 tw-leading-relaxed">
                            ${lifePathData.summary || lifePathData}
                        </p>
                    </div>

                    <!-- Numerology Table -->
                    ${renderNumerologyTable(data)}

                    <!-- Pythagorean Square -->
                    <div class="tw-mt-10">
                        <h3 class="tw-text-2xl tw-font-semibold tw-mb-6 tw-text-center tw-text-gray-800">
                            <i class="fas fa-th tw-mr-2"></i>Pythagorean Square
                        </h3>
                        <div id="pythagorean-container" class="tw-text-center tw-py-6">
                            <div class="tw-animate-pulse tw-text-gray-500">
                                <i class="fas fa-spinner tw-spin tw-mr-2"></i>
                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç...
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== MAIN EXECUTION ====================
        async function initializePage() {
            try {
                DebugLogger.log('=== Initializing Result Page ===');
                
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL
                const data = getDataFromURL();
                DebugLogger.log(`üì• URL Data: ${JSON.stringify(data)}`);

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                if (!data.birth_date || !data.destiny_number || !data.life_path_number) {
                    throw new Error("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (birth_date, destiny_number, life_path_number)");
                }

                // ‡∏î‡∏∂‡∏á LifePath ‡∏à‡∏≤‡∏Å Supabase
                DebugLogger.log(`üîç Loading LifePath ${data.life_path_number}...`);
                const lifePathData = await fetchLifePathMeaning(data.life_path_number);
                
                // Render ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                document.getElementById('result-content').innerHTML = renderResult(data, lifePathData);
                document.getElementById('loading-message').style.display = 'none';
                document.getElementById('result-content').style.display = 'block';

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Pythagorean Square
                const birthNumbers = data.birth_date.replace(/[:\/ ]/g, '');
                const counts = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
                birthNumbers.split('').forEach(d => {
                    const num = parseInt(d);
                    if(num >= 1 && num <= 9) counts[num]++;
                });
                
                document.getElementById('pythagorean-container').innerHTML = renderPythagoreanSquare(counts);
                DebugLogger.log('‚úÖ Pythagorean Square rendered');

            } catch (error) {
                DebugLogger.error(`‚ùå Fatal error: ${error.message}`);
                document.getElementById('loading-message').innerHTML = 
                    `<div class="tw-text-red-500 tw-text-center tw-p-4">
                        <p class="tw-font-bold tw-text-lg">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
                        <p class="tw-text-sm tw-mt-2">${error.message}</p>
                        <button onclick="history.back()" class="tw-bg-blue-500 tw-text-white tw-px-4 tw-py-2 tw-rounded tw-mt-4 hover:tw-bg-blue-600">
                            ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>`;
            }
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', initializePage);

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô Numerology Table
        document.addEventListener('click', async (e) => {
            const link = e.target.closest('.numerology-link');
            if (link) {
                e.preventDefault();
                const href = link.dataset.href;
                const content = await fetchGitHubContent(href);
                document.getElementById('explained-content').innerHTML = content;
                document.querySelector('[onclick*="Explained"]').click();
            }
        });
    </script>
</body>
</html>

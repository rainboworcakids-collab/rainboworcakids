<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychomatrix Analysis - RainbowOrcaKids</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/PsychomatrixStyle.css">
    
    <!-- Favicon -->
    <link rel="icon" href="images/PsychomatixAnalize.png" type="image/png">
    
    <!-- Scripts ตามลำดับ (ใช้ที่มีอยู่แล้ว) -->
    <script src="js/supabase-config.js"></script>
    <script src="js/debug-logger.js"></script>
    <script src="js/auth_status_manager.js"></script>
    <script src="js/nav.js"></script>
</head>
<body class="tw-bg-gray-100 tw-p-4">
    <!-- Navigation Bar (ใช้ nav.js) -->
    <div id="nav-container"></div>

    <div class="tw-max-w-4xl tw-mx-auto tw-mt-6">
        <!-- Tabs -->
        <div class="tw-flex tw-border-b tw-border-gray-300">
            <button class="tablink active" onclick="switchTab('Main', this)">Main</button>
            <button class="tablink" onclick="switchTab('Explained', this)">Explained</button>
        </div>

        <!-- Main Tab -->
        <div id="Main" class="tabcontent active tw-bg-white tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <h1 class="tw-text-3xl tw-font-bold tw-text-center tw-mb-6">
                <img src="https://rainboworcakids-collab.github.io/rainboworcakids/images/PsychomatixAnalize.png" 
                     alt="Logo" class="tw-h-16 tw-w-16 tw-inline tw-mr-3">
                Psychomatrix Analysis
            </h1>
            <div id="loading-message" class="tw-text-center tw-py-8 tw-text-gray-500">
                กำลังโหลดข้อมูลจากระบบ...
            </div>
            <div id="result-content" class="tw-hidden">
                <!-- เนื้อหาจะถูก render ที่นี่ -->
            </div>
        </div>

        <!-- Explained Tab -->
        <div id="Explained" class="tabcontent tw-bg-white tw-p-6 tw-rounded tw-shadow tw-mt-4">
            <div id="explained-content">
                <p class="tw-text-gray-500 tw-text-center">เลือกลิงก์จากตารางเพื่อดูรายละเอียดเพิ่มเติม</p>
            </div>
        </div>
    </div>

    <!-- Result-specific Script -->
    <script>
        // ==================== UTILITY FUNCTIONS ====================
        function switchTab(tabName, el) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tablink').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            el.classList.add('active');
        }

        async function fetchFromSupabase(elementType, rootNumber) {
            try {
                DebugLogger.log(`Fetching ${elementType} data for root_number: ${rootNumber}`);
                
                const response = await fetch(
                    `${window.SUPABASE_URL}/rest/v1/numerology_search_index?` + 
                    `element_type=eq.${elementType}&root_number=eq.${rootNumber}`, 
                    {
                        headers: {
                            'apikey': window.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`
                        }
                    }
                );
                
                const data = await response.json();
                DebugLogger.log(`Received: ${data.length} records`);
                return data[0];
            } catch (error) {
                DebugLogger.error(`Supabase fetch failed: ${error.message}`);
                return null;
            }
        }

        async function fetchGitHubContent(path) {
            try {
                const url = `https://rainboworcakids-collab.github.io/rainboworcakids${path}`;
                DebugLogger.log(`Loading from GitHub: ${url}`);
                
                const response = await fetch(url);
                return await response.text();
            } catch (error) {
                DebugLogger.error(`GitHub fetch failed: ${error.message}`);
                return '<p class="tw-text-red-500">ไม่สามารถโหลดเนื้อหาได้</p>';
            }
        }

        function renderNumerologyTable(data) {
            const destinyLink = `/PsychomatrixContents/Destiny${data.destiny_number}.html`;
            const lifePathLink = `/PsychomatrixContents/LifePathNumber${data.life_path_number}.html`;

            return `
                <div class="tw-overflow-x-auto tw-my-6">
                    <table class="tw-w-full tw-border-collapse tw-border tw-border-gray-300">
                        <thead>
                            <tr class="tw-bg-gray-100">
                                <th class="tw-border tw-border-gray-300 tw-p-3">วันเกิด</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3">เดือนเกิด</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3">ปีเกิด</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3">โชคชะตา</th>
                                <th class="tw-border tw-border-gray-300 tw-p-3">เส้นทางชีวิต</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_day || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_month || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3">${data.birth_year || '-'}</td>
                                <td class="tw-border tw-border-gray-300 tw-p-3 tw-bg-blue-50 hover:tw-bg-blue-100 tw-cursor-pointer">
                                    <a href="#" class="tw-font-bold tw-text-blue-600 numerology-link hover:tw-text-blue-800" 
                                       data-href="${destinyLink}" data-tab="Explained">
                                        ${data.destiny_number}
                                    </a>
                                </td>
                                <td class="tw-border tw-border-gray-300 tw-p-3 tw-bg-green-50 hover:tw-bg-green-100 tw-cursor-pointer">
                                    <a href="#" class="tw-font-bold tw-text-green-600 numerology-link hover:tw-text-green-800" 
                                       data-href="${lifePathLink}" data-tab="Explained">
                                        ${data.life_path_number}
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPythagoreanSquare(counts) {
            const grid = `
                <div class="tw-grid tw-grid-cols-4 tw-gap-2 tw-max-w-sm tw-mx-auto tw-my-6">
                    <div class="tw-border-2 tw-border-gray-400 tw-p-4 tw-text-center tw-font-bold">${counts['1'] || 0}</div>
                    <div class="tw-border-2 tw-border-gray-400 tw-p-4 tw-text-center tw-font-bold">${counts['2'] || 0}</div>
                    <div class="tw-border-2 tw-border-gray-400 tw-p-4 tw-text-center tw-font-bold">${counts['3'] || 0}</div>
                    <div class="tw-border-2 tw-border-gray-400 tw-p-4 tw-text-center tw-font-bold">${counts['4'] || 0}</div>
                    <div class="tw-border-2 tw-border-gray-400 tw-p-4 tw-text-center tw-font-bold">${counts['5'] || 0}</div>
                    <div class="tw-border-2 tw-border-gray-400 tw-p-4 tw-text-center tw-font-bold">${counts['6'] || 0}</div>
                    <div class="tw-border-2 tw-border-gray-400 tw-p-4 tw-text-center tw-font-bold">${counts['7'] || 0}</div>
                    <div class="tw-border-2 tw-border-gray-400 tw-p-4 tw-text-center tw-font-bold">${counts['8'] || 0}</div>
                    <div class="tw-border-2 tw-border-gray-400 tw-p-4 tw-text-center tw-font-bold">${counts['9'] || 0}</div>
                    <div class="tw-col-span-4 tw-text-center tw-text-xs tw-text-gray-500 tw-mt-2">
                        พลังงานตัวเลข 1-9 (เซลล์ที่ 1-9)
                    </div>
                </div>
            `;
            return grid;
        }

        // ==================== MAIN EXECUTION ====================
        async function loadAndDisplayResult() {
            try {
                DebugLogger.log('=== Starting Result Page Load ===');
                
                // โหลดข้อมูลจาก Edge Function (ตัวอย่าง)
                const resultData = {
                    success: true,
                    birth_date: "13:05 22/05/1968",
                    birth_numbers: "130522051968",
                    birth_day: "22",
                    birth_month: "05",
                    birth_year: "1968",
                    destiny_number: 42,
                    life_path_number: 6,
                    life_path_meaning: "ผู้มีความรับผิดชอบสูง รักครอบครัว...",
                    karmic_number: 3
                };

                DebugLogger.log(`Data loaded: ${JSON.stringify(resultData)}`);

                // ดึง LifePath content จาก Supabase (เพิ่มเติม)
                const lifePathData = await fetchFromSupabase('LifePath', resultData.life_path_number);
                if (lifePathData && lifePathData.summary) {
                    resultData.life_path_meaning = lifePathData.summary;
                    DebugLogger.log('Updated meaning from Supabase');
                }

                // Render เนื้อหา
                const contentHTML = `
                    <div class="tw-mb-6">
                        <h2 class="tw-text-2xl tw-font-bold tw-mb-4 tw-text-center">
                            วันเวลาเกิด: ${resultData.birth_date}
                        </h2>
                        
                        <!-- Summary Cards -->
                        <div class="tw-grid md:tw-grid-cols-2 tw-gap-6 tw-mb-6">
                            <div class="tw-bg-blue-50 tw-border-l-4 tw-border-blue-500 tw-p-4 tw-rounded">
                                <h3 class="tw-text-lg tw-font-semibold tw-text-blue-800">เลขภาระกิจ</h3>
                                <p class="tw-text-3xl tw-font-bold tw-text-blue-600">
                                    ${resultData.destiny_number} → ${resultData.destiny_number % 9 || 9}
                                </p>
                            </div>
                            <div class="tw-bg-green-50 tw-border-l-4 tw-border-green-500 tw-p-4 tw-rounded">
                                <h3 class="tw-text-lg tw-font-semibold tw-text-green-800">เลขเส้นทางชีวิต</h3>
                                <p class="tw-text-3xl tw-font-bold tw-text-green-600">
                                    ${resultData.life_path_number}
                                </p>
                            </div>
                        </div>

                        <!-- Life Path Meaning -->
                        <div class="tw-bg-gray-50 tw-p-4 tw-rounded tw-border tw-border-gray-200 tw-mb-6">
                            <h3 class="tw-font-semibold tw-mb-2">ความหมายเส้นทางชีวิต:</h3>
                            <p class="tw-text-gray-700">${resultData.life_path_meaning}</p>
                        </div>

                        <!-- Numerology Table -->
                        ${renderNumerologyTable(resultData)}

                        <!-- Pythagorean Square -->
                        <div class="tw-mt-8">
                            <h3 class="tw-text-xl tw-font-semibold tw-mb-4">Pythagorean Square</h3>
                            <div id="pythagorean-container" class="tw-text-center tw-py-4">
                                กำลังคำนวณพลังงานตัวเลข...
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('result-content').innerHTML = contentHTML;
                document.getElementById('loading-message').classList.add('tw-hidden');
                document.getElementById('result-content').classList.remove('tw-hidden');

                // โหลด Pythagorean Square
                loadPythagoreanSquare(resultData.birth_numbers);
                
                DebugLogger.log('=== Result Page Load Complete ===');

            } catch (error) {
                DebugLogger.error(`Fatal error: ${error.message}`);
                document.getElementById('loading-message').innerHTML = 
                    `<div class="tw-text-red-500 tw-text-center">
                        <p>เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                        <p class="tw-text-xs tw-mt-2">${error.message}</p>
                    </div>`;
            }
        }

        async function loadPythagoreanSquare(birthNumbers) {
            try {
                // คำนวณ counts จาก birthNumbers (สมมติเป็นตัวอย่าง)
                const counts = {};
                for (let i = 1; i <= 9; i++) counts[i] = 0;
                
                birthNumbers.split('').forEach(d => {
                    const num = parseInt(d);
                    if (num > 0) counts[num]++;
                });

                document.getElementById('pythagorean-container').innerHTML = renderPythagoreanSquare(counts);
                DebugLogger.log('Pythagorean Square rendered');
            } catch (error) {
                DebugLogger.error(`Pythagorean render failed: ${error.message}`);
            }
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', async () => {
            DebugLogger.log('DOM Content Loaded');
            await loadAndDisplayResult();
        });

        // จัดการลิงก์ใน Numerology Table
        document.addEventListener('click', async (e) => {
            const link = e.target.closest('.numerology-link');
            if (link) {
                e.preventDefault();
                const href = link.dataset.href;
                const targetTab = link.dataset.tab;
                
                DebugLogger.log(`Link clicked: ${href}`);
                
                const content = await fetchGitHubContent(href);
                document.getElementById('explained-content').innerHTML = content;
                
                // สลับไปแท็บ Explained
                const explainedTab = document.querySelector('[onclick*="Explained"]');
                if (explainedTab) explainedTab.click();
            }
        });
    </script>
</body>
</html>
